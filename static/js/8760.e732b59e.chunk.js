"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[8760],{31581:function(e,t,r){r.d(t,{r:function(){return i}});var n=r(36231);function i(e,t){if(!(this instanceof i))return new i(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}function s(e,t,r){if(!r)return t.indexOf(e);for(var n=0;n<t.length;n++)if(r(e,t[n]))return n;return-1}function a(e,t){o(e,0,e.children.length,t,e)}function o(e,t,r,n,i){i||(i=g(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var s,a=t;a<r;a++)s=e.children[a],u(i,e.leaf?n(s):s);return i}function u(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function c(e,t){return e.minX-t.minX}function l(e,t){return e.minY-t.minY}function h(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function d(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function v(e,t){var r=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,i-r)*Math.max(0,s-n)}function p(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function y(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function _(e,t,r,i,s){for(var a,o=[t,r];o.length;)(r=o.pop())-(t=o.pop())<=i||(a=t+Math.ceil((r-t)/i/2)*i,(0,n.q)(e,a,t,r,s),o.push(t,a,a,r))}i.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],n=this.toBBox;if(!y(e,t))return r;for(var i,s,a,o,u=[];t;){for(i=0,s=t.children.length;i<s;i++)a=t.children[i],y(e,o=t.leaf?n(a):a)&&(t.leaf?r.push(a):p(e,o)?this._all(a,r):u.push(a));t=u.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!y(e,t))return!1;for(var n,i,s,a,o=[];t;){for(n=0,i=t.children.length;n<i;n++)if(s=t.children[n],y(e,a=t.leaf?r(s):s)){if(t.leaf||p(e,a))return!0;o.push(s)}t=o.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var n=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=g([]),this},remove:function(e,t){if(!e)return this;for(var r,n,i,a,o=this.data,u=this.toBBox(e),c=[],l=[];o||c.length;){if(o||(o=c.pop(),n=c[c.length-1],r=l.pop(),a=!0),o.leaf&&-1!==(i=s(e,o.children,t)))return o.children.splice(i,1),c.push(o),this._condense(c),this;a||o.leaf||!p(o,u)?n?(r++,o=n.children[r],a=!1):o=null:(c.push(o),l.push(r),r=0,n=o,o=o.children[0])}return this},toBBox:function(e){return e},compareMinX:c,compareMinY:l,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,n){var i,s=r-t+1,o=this._maxEntries;if(s<=o)return a(i=g(e.slice(t,r+1)),this.toBBox),i;n||(n=Math.ceil(Math.log(s)/Math.log(o)),o=Math.ceil(s/Math.pow(o,n-1))),(i=g([])).leaf=!1,i.height=n;var u,c,l,h,d=Math.ceil(s/o),f=d*Math.ceil(Math.sqrt(o));for(_(e,t,r,f,this.compareMinX),u=t;u<=r;u+=f)for(_(e,u,l=Math.min(u+f-1,r),d,this.compareMinY),c=u;c<=l;c+=d)h=Math.min(c+d-1,l),i.children.push(this._build(e,c,h,n-1));return a(i,this.toBBox),i},_chooseSubtree:function(e,t,r,n){for(var i,s,a,o,u,c,l,d;n.push(t),!t.leaf&&n.length-1!==r;){for(l=d=1/0,i=0,s=t.children.length;i<s;i++)u=h(a=t.children[i]),(c=f(e,a)-u)<d?(d=c,l=u<l?u:l,o=a):c===d&&u<l&&(l=u,o=a);t=o||t.children[0]}return t},_insert:function(e,t,r){var n=this.toBBox,i=r?e:n(e),s=[],a=this._chooseSubtree(i,this.data,t,s);for(a.children.push(e),u(a,i);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(i,s,t)},_split:function(e,t){var r=e[t],n=r.children.length,i=this._minEntries;this._chooseSplitAxis(r,i,n);var s=this._chooseSplitIndex(r,i,n),o=g(r.children.splice(s,r.children.length-s));o.height=r.height,o.leaf=r.leaf,a(r,this.toBBox),a(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(r,o)},_splitRoot:function(e,t){this.data=g([e,t]),this.data.height=e.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var n,i,s,a,u,c,l,d;for(c=l=1/0,n=t;n<=r-t;n++)a=v(i=o(e,0,n,this.toBBox),s=o(e,n,r,this.toBBox)),u=h(i)+h(s),a<c?(c=a,d=n,l=u<l?u:l):a===c&&u<l&&(l=u,d=n);return d},_chooseSplitAxis:function(e,t,r){var n=e.leaf?this.compareMinX:c,i=e.leaf?this.compareMinY:l;this._allDistMargin(e,t,r,n)<this._allDistMargin(e,t,r,i)&&e.children.sort(n)},_allDistMargin:function(e,t,r,n){e.children.sort(n);var i,s,a=this.toBBox,c=o(e,0,t,a),l=o(e,r-t,r,a),h=d(c)+d(l);for(i=t;i<r-t;i++)s=e.children[i],u(c,e.leaf?a(s):s),h+=d(c);for(i=r-t-1;i>=t;i--)s=e.children[i],u(l,e.leaf?a(s):s),h+=d(l);return h},_adjustParentBBoxes:function(e,t,r){for(var n=r;n>=0;n--)u(t[n],e)},_condense:function(e){for(var t,r=e.length-1;r>=0;r--)0===e[r].children.length?r>0?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():a(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}},43244:function(e,t,r){r.d(t,{Z:function(){return o}});var n=r(37762),i=r(15671),s=r(43144),a=r(92026),o=function(){function e(t){(0,i.Z)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return(0,s.Z)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,r=(0,n.Z)(this._buffer);try{for(r.s();!(t=r.n()).done;){var i=t.value;if((0,a.pC)(i)&&e(i))return i}}catch(s){r.e(s)}finally{r.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,a.pC)(t);)e&&e(t),t=this.dequeue()}}]),e}()},59068:function(e,t,r){r.d(t,{Z:function(){return v}});var n,i=r(15671),s=r(43144),a=r(60136),o=r(29388),u=r(27366),c=r(46784),l=r(49861),h=(r(63780),r(93169),r(25243)),d=r(69912),f=n=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e)).cols=null,n.level=0,n.levelValue=null,n.origin=null,n.resolution=0,n.rows=null,n.scale=0,n}return(0,s.Z)(r,[{key:"clone",value:function(){return new n({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}}]),r}(c.wq);(0,u._)([(0,l.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],f.prototype,"cols",void 0),(0,u._)([(0,l.Cb)({type:h.z8,json:{write:!0}})],f.prototype,"level",void 0),(0,u._)([(0,l.Cb)({type:String,json:{write:!0}})],f.prototype,"levelValue",void 0),(0,u._)([(0,l.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],f.prototype,"origin",void 0),(0,u._)([(0,l.Cb)({type:Number,json:{write:!0}})],f.prototype,"resolution",void 0),(0,u._)([(0,l.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],f.prototype,"rows",void 0),(0,u._)([(0,l.Cb)({type:Number,json:{write:!0}})],f.prototype,"scale",void 0);var v=f=n=(0,u._)([(0,d.j)("esri.layers.support.LOD")],f)},22824:function(e,t,r){r.d(t,{Z:function(){return C}});var n,i=r(1413),s=r(15671),a=r(43144),o=r(60136),u=r(29388),c=r(27366),l=r(43404),h=r(46784),d=r(92026),f=r(68860),v=r(49861),p=(r(63780),r(93169),r(25243)),y=r(38511),g=r(69912),_=r(31201),m=r(7882),k=r(78952),x=r(65156),b=r(92975),I=r(81753),w=r(59068),S=new l.X({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"}),Z=n=function(e){(0,o.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,s.Z)(this,r),(n=t.call(this,e)).dpi=96,n.format=null,n.origin=null,n.minScale=0,n.maxScale=0,n.size=null,n.spatialReference=null,n}return(0,a.Z)(r,[{key:"isWrappable",get:function(){var e=this.spatialReference,t=this.origin;if(e&&t){var r=(0,b.C5)(e);return e.isWrappable&&Math.abs(r.origin[0]-t.x)<=r.dx}return!1}},{key:"readOrigin",value:function(e,t){return m.Z.fromJSON((0,i.Z)({spatialReference:t.spatialReference},e))}},{key:"lods",set:function(e){var t=this,r=0,n=0,i=[];this._levelToLOD={},e&&(r=-1/0,n=1/0,e.forEach((function(e){i.push(e.scale),r=e.scale>r?e.scale:r,n=e.scale<n?e.scale:n,t._levelToLOD[e.level]=e}))),this._set("scales",i),this._set("minScale",r),this._set("maxScale",n),this._set("lods",e),this._initializeUpsampleLevels()}},{key:"readSize",value:function(e,t){return[t.cols,t.rows]}},{key:"writeSize",value:function(e,t){t.cols=e[0],t.rows=e[1]}},{key:"zoomToScale",value:function(e){var t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];var r=Math.floor(e),n=r+1;return t[r]/Math.pow(t[r]/t[n],e-r)}},{key:"scaleToZoom",value:function(e){for(var t=this.scales,r=t.length-1,n=0;n<r;n++){var i=t[n],s=t[n+1];if(i<=e)return n;if(s===e)return n+1;if(i>e&&s<e)return n+Math.log(i/e)/Math.log(i/s)}return n}},{key:"snapScale",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.95,r=this.scaleToZoom(e);return r%Math.floor(r)>=t?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))}},{key:"tileAt",value:function(e,t,r,n){var i,s,a=this.lodAt(e);if(!a)return null;if("number"==typeof t)i=t,s=r;else if((0,b.fS)(t.spatialReference,this.spatialReference))i=t.x,s=t.y,n=r;else{var o=(0,I.iV)(t,this.spatialReference);if((0,d.Wi)(o))return null;i=o.x,s=o.y,n=r}var u=a.resolution*this.size[0],c=a.resolution*this.size[1];return n||(n={id:null,level:0,row:0,col:0,extent:(0,x.Ue)()}),n.level=e,n.row=Math.floor((this.origin.y-s)/c+.001),n.col=Math.floor((i-this.origin.x)/u+.001),this.updateTileInfo(n),n}},{key:"updateTileInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.ExtrapolateOptions.NONE,r=this.lodAt(e.level);if(!r&&t===n.ExtrapolateOptions.POWER_OF_TWO){var i=this.lods[this.lods.length-1];i.level<e.level&&(r=i)}if(r){var s=e.level-r.level,a=r.resolution*this.size[0]/Math.pow(2,s),o=r.resolution*this.size[1]/Math.pow(2,s);e.id="".concat(e.level,"/").concat(e.row,"/").concat(e.col),e.extent||(e.extent=(0,x.Ue)()),e.extent[0]=this.origin.x+e.col*a,e.extent[1]=this.origin.y-(e.row+1)*o,e.extent[2]=e.extent[0]+a,e.extent[3]=e.extent[1]+o}}},{key:"upsampleTile",value:function(e){var t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)}},{key:"getTileBounds",value:function(e,t){var r=this.lodAt(t.level).resolution,n=r*this.size[0],i=r*this.size[1];return e[0]=this.origin.x+t.col*n,e[1]=this.origin.y-(t.row+1)*i,e[2]=e[0]+n,e[3]=e[1]+i,e}},{key:"lodAt",value:function(e){return this._levelToLOD&&this._levelToLOD[e]||null}},{key:"clone",value:function(){return n.fromJSON(this.write({}))}},{key:"getOrCreateCompatible",value:function(e,t){if(256===this.size[0]&&256===this.size[1])return 256===e?this:null;for(var r=[],i=this.lods.length,s=0;s<i;s++){var a=this.lods[s],o=a.resolution*t;r.push(new w.Z({level:a.level,scale:a.scale,resolution:o}))}return new n({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}},{key:"_initializeUpsampleLevels",value:function(){var e=this.lods;this._upsampleLevels=[];for(var t=null,r=0;r<e.length;r++){var n=e[r];this._upsampleLevels[n.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/n.resolution:0},t=n}}}],[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.resolutionFactor,r=void 0===t?1:t,i=e.scales,s=e.size,a=void 0===s?256:s,o=e.spatialReference,u=void 0===o?k.Z.WebMercator:o,c=e.numLODs,l=void 0===c?24:c;if(!(0,b.JY)(u)){var h=[];if(i)for(var d=0;d<i.length;d++){var v=i[d];h.push({level:d,scale:v,resolution:v})}else for(var p=5e-4,y=l-1;y>=0;y--)h.unshift({level:y,scale:p,resolution:p}),p*=2;return new n({dpi:96,lods:h,origin:new m.Z(0,0,u),size:[a,a],spatialReference:u})}var g=(0,b.C5)(u),_=e.origin?new m.Z({x:e.origin.x,y:e.origin.y,spatialReference:u}):new m.Z(g?{x:g.origin[0],y:g.origin[1],spatialReference:u}:{x:0,y:0,spatialReference:u}),x=96,I=1/(39.37*(0,f.c9)(u)*x),w=[];if(i)for(var S=0;S<i.length;S++){var Z=i[S],C=Z*I;w.push({level:S,scale:Z,resolution:C})}else{var F=(0,b.sT)(u)?512/a*591657527.5917094:256/a*591657527.591555,T=Math.ceil(l/r);w.push({level:0,scale:F,resolution:F*I});for(var A=1;A<T;A++){var E=F/Math.pow(2,r),M=E*I;w.push({level:A,scale:E,resolution:M}),F=E}}return new n({dpi:x,lods:w,origin:_,size:[a,a],spatialReference:u})}}]),r}(h.wq);(0,c._)([(0,v.Cb)({type:Number,json:{write:!0}})],Z.prototype,"compressionQuality",void 0),(0,c._)([(0,v.Cb)({type:Number,json:{write:!0}})],Z.prototype,"dpi",void 0),(0,c._)([(0,v.Cb)({type:String,json:{read:S.read,write:S.write,origins:{"web-scene":{read:!1,write:!1}}}})],Z.prototype,"format",void 0),(0,c._)([(0,v.Cb)({readOnly:!0})],Z.prototype,"isWrappable",null),(0,c._)([(0,v.Cb)({type:m.Z,json:{write:!0}})],Z.prototype,"origin",void 0),(0,c._)([(0,y.r)("origin")],Z.prototype,"readOrigin",null),(0,c._)([(0,v.Cb)({type:[w.Z],value:null,json:{write:!0}})],Z.prototype,"lods",null),(0,c._)([(0,v.Cb)({readOnly:!0})],Z.prototype,"minScale",void 0),(0,c._)([(0,v.Cb)({readOnly:!0})],Z.prototype,"maxScale",void 0),(0,c._)([(0,v.Cb)({readOnly:!0})],Z.prototype,"scales",void 0),(0,c._)([(0,v.Cb)({cast:function(e){return Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]}})],Z.prototype,"size",void 0),(0,c._)([(0,y.r)("size",["rows","cols"])],Z.prototype,"readSize",null),(0,c._)([(0,_.c)("size",{cols:{type:p.z8},rows:{type:p.z8}})],Z.prototype,"writeSize",null),(0,c._)([(0,v.Cb)({type:k.Z,json:{write:!0}})],Z.prototype,"spatialReference",void 0),function(e){var t;(t=e.ExtrapolateOptions||(e.ExtrapolateOptions={}))[t.NONE=0]="NONE",t[t.POWER_OF_TWO=1]="POWER_OF_TWO"}((Z=n=(0,c._)([(0,g.j)("esri.layers.support.TileInfo")],Z))||(Z={}));var C=Z},22585:function(e,t,r){function n(e){var t={};for(var r in e)if("declaredClass"!==r){var i=e[r];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){t[r]=[];for(var s=0;s<i.length;s++)t[r][s]=n(i[s])}else"object"==typeof i?i.toJSON&&(t[r]=JSON.stringify(i)):t[r]=i}return t}r.d(t,{A:function(){return n}})},5192:function(e,t,r){r.r(t),r.d(t,{encodeGeometry:function(){return p},executeQuery:function(){return g},executeQueryForCount:function(){return I},executeQueryForExtent:function(){return w},executeQueryForIds:function(){return b},executeQueryPBF:function(){return m},executeQueryPBFBuffer:function(){return x},queryToQueryStringParameters:function(){return y},runQuery:function(){return S}});var n=r(1413),i=r(15861),s=r(87757),a=r(76200),o=r(92026),u=r(35995),c=r(77981),l=r(41862),h=r(22585),d=r(27607),f=r(68620),v="Layer does not support extent calculation.";function p(e,t){if(t&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(t&&"point"===e.type)return"".concat(e.x,",").concat(e.y);var r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}function y(e,t){var r=e.geometry,n=e.toJSON();delete n.compactGeometryEnabled,delete n.defaultSpatialReferenceEnabled;var i,s,a=n,u=e.outSpatialReference;if((0,o.pC)(r)&&(i=r.spatialReference,s=r.spatialReference.wkid||JSON.stringify(r.spatialReference),a.geometryType=(0,c.Ji)(r),a.geometry=p(r,e.compactGeometryEnabled),a.inSR=s),n.groupByFieldsForStatistics&&(a.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(a.objectIds=n.objectIds.join(",")),n.orderByFields&&(a.orderByFields=n.orderByFields.join(",")),!n.outFields||!n.returnDistinctValues&&(null!=t&&t.returnCountOnly||null!=t&&t.returnExtentOnly||null!=t&&t.returnIdsOnly)?delete a.outFields:-1!==n.outFields.indexOf("*")?a.outFields="*":a.outFields=n.outFields.join(","),n.outSR?a.outSR=n.outSR.wkid||JSON.stringify(n.outSR):r&&(n.returnGeometry||n.returnCentroid)&&(a.outSR=a.inSR),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(a.outStatistics=JSON.stringify(n.outStatistics)),n.pixelSize&&(a.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&(0,o.pC)(i)&&(0,o.pC)(e.quantizationParameters)&&(0,o.pC)(e.quantizationParameters.extent)&&i.equals(e.quantizationParameters.extent.spatialReference)&&delete n.quantizationParameters.extent.spatialReference,a.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.parameterValues&&(a.parameterValues=JSON.stringify(n.parameterValues)),n.rangeValues&&(a.rangeValues=JSON.stringify(n.rangeValues)),n.dynamicDataSource&&(a.layer=JSON.stringify({source:n.dynamicDataSource}),delete n.dynamicDataSource),n.timeExtent){var l=n.timeExtent,h=l.start,d=l.end;null==h&&null==d||(a.time=h===d?h:"".concat(null==h?"null":h,",").concat(null==d?"null":d)),delete n.timeExtent}return e.defaultSpatialReferenceEnabled&&(0,o.pC)(i)&&(0,o.pC)(u)&&i.equals(u)&&(a.defaultSR=a.inSR,delete a.inSR,delete a.outSR),a}function g(e,t,r,n){return _.apply(this,arguments)}function _(){return(_=(0,i.Z)(s.mark((function e(t,r,n,i){var a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,o.pC)(r.timeExtent)||!r.timeExtent.isEmpty){e.next=4;break}e.t0={data:{features:[]}},e.next=7;break;case 4:return e.next=6,S(t,r,"json",i);case 6:e.t0=e.sent;case 7:return a=e.t0,e.abrupt("return",((0,f.p)(r,n,a.data),a));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e,t,r,n){return k.apply(this,arguments)}function k(){return(k=(0,i.Z)(s.mark((function e(t,r,n,i){var a,u;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,o.pC)(r.timeExtent)||!r.timeExtent.isEmpty){e.next=2;break}return e.abrupt("return",Promise.resolve({data:n.createFeatureResult()}));case 2:return e.next=4,x(t,r,i);case 4:return a=e.sent,u=a,e.abrupt("return",(u.data=(0,d.C)(a.data,n),u));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e,t,r){return S(e,t,"pbf",r)}function b(e,t,r){return(0,o.pC)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):S(e,t,"json",r,{returnIdsOnly:!0})}function I(e,t,r){return(0,o.pC)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):S(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function w(e,t,r){return(0,o.pC)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):S(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then((function(e){var t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(v);if(t.hasOwnProperty("count"))throw new Error(v);return e}))}function S(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},c="string"==typeof e?(0,u.mN)(e):e,d=t.geometry?[t.geometry]:[];return i.responseType="pbf"===r?"array-buffer":"json",(0,l.aX)(d,null,i).then((function(e){var l=e&&e[0];(0,o.pC)(l)&&((t=t.clone()).geometry=l);var d=(0,h.A)((0,n.Z)((0,n.Z)((0,n.Z)({},c.query),{},{f:r},s),y(t,s)));return(0,a.default)((0,u.v_)(c.path,"query"),(0,n.Z)((0,n.Z)({},i),{},{query:(0,n.Z)((0,n.Z)({},d),i.query)}))}))}},84328:function(e,t,r){r.d(t,{KS:function(){return c},PX:function(){return s},QS:function(){return h},_I:function(){return n},jL:function(){return u},nE:function(){return l},vs:function(){return o},xp:function(){return a}});var n=8388607,i=8388608,s=0,a=1,o=function(e){return(e&i)>>>23},u=function(e){return e&n},c=function(e){return o(e)===a?254:255};function l(e){return o(e)===a}function h(e,t){return((t?i:0)|e)>>>0}},46640:function(e,t,r){r.d(t,{ws:function(){return E},xV:function(){return M},UK:function(){return O},$_:function(){return A}});var n=r(4942),i=r(37762),s=r(10064),a=r(32718),o=(r(16889),r(48202)),u=(r(65800),r(80613)),c=r(15671),l=r(43144),h=r(13005),d=function(){function e(){(0,c.Z)(this,e),this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}return(0,l.Z)(e,[{key:"acquire",value:function(e,t,r,n,i,s,a,o,u){this.color=e,this.haloColor=t,this.haloSize=r,this.size=n,this.angle=i,this.offsetX=s,this.offsetY=a,this.hAnchor=o,this.vAnchor=u}},{key:"release",value:function(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}]),e}();d.pool=new h.Z(d);var f=r(8548),v=(r(51378),a.Z.getLogger("esri.views.2d.engine.webgl.Utils")),p="geometry",y=[{name:p,strideInBytes:32}],g=[{name:p,strideInBytes:20}],_=[{name:p,strideInBytes:12}],m=[{name:p,strideInBytes:40}],k=[{name:p,strideInBytes:36}],x=[{name:p,strideInBytes:36}];function b(e){var t,r={},n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var s=t.value;r[s.name]=s.strideInBytes}}catch(a){n.e(a)}finally{n.f()}return r}var I=b([{name:p,strideInBytes:36}]),w=b(y),S=b(g),Z=b(_),C=b(m),F=b(k),T=b(x);function A(e,t){var r=t.fill;switch(e){case u.LW.MARKER:return I;case u.LW.FILL:return"dot-density"===r?Z:"simple"===r?S:w;case u.LW.LINE:return C;case u.LW.TEXT:return F;case u.LW.LABEL:return T}}function E(e){switch(e){case"butt":return o.RL.BUTT;case"round":return o.RL.ROUND;case"square":return o.RL.SQUARE;default:return v.error(new s.Z("mapview-invalid-type","Cap type ".concat(e," is not a valid option. Defaulting to round"))),o.RL.ROUND}}function M(e){switch(e){case"miter":return o.AH.MITER;case"bevel":return o.AH.BEVEL;case"round":return o.AH.ROUND;default:return v.error(new s.Z("mapview-invalid-type","Join type ".concat(e," is not a valid option. Defaulting to round"))),o.AH.ROUND}}(0,n.Z)({},p,f.l1.STATIC_DRAW);function O(e){switch(e){case f.Br.UNSIGNED_BYTE:return Uint8Array;case f.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case f.Br.FLOAT:return Float32Array;default:return void v.error(new s.Z("webgl-utils","Unable to handle type ".concat(e)))}}new Map},65800:function(e,t,r){r.d(t,{aH:function(){return a},t2:function(){return s}});var n=r(70885),i=r(73271);function s(e){if(!e)return 0;var t=e.r,r=e.g,n=e.b,s=e.a;return(0,i.Jz)(t*s,r*s,n*s,255*s)}function a(e){if(!e)return 0;var t=(0,n.Z)(e,4),r=t[0],s=t[1],a=t[2],o=t[3];return(0,i.Jz)(r*(o/255),s*(o/255),a*(o/255),o)}},80613:function(e,t,r){var n,i,s,a,o,u,c;r.d(t,{LW:function(){return n},X:function(){return o},mf:function(){return u}}),function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT",e[e.LABEL=4]="LABEL"}(n||(n={})),function(e){e[e.SUCCEEDED=0]="SUCCEEDED",e[e.FAILED_OUT_OF_MEMORY=1]="FAILED_OUT_OF_MEMORY"}(i||(i={})),function(e){e[e.NONE=0]="NONE",e[e.MAP=1]="MAP",e[e.LABEL=2]="LABEL",e[e.LABEL_ALPHA=4]="LABEL_ALPHA",e[e.HITTEST=8]="HITTEST",e[e.HIGHLIGHT=16]="HIGHLIGHT",e[e.CLIP=32]="CLIP",e[e.DEBUG=64]="DEBUG",e[e.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(s||(s={})),function(e){e[e.SIZE=0]="SIZE",e[e.COLOR=1]="COLOR",e[e.OPACITY=2]="OPACITY",e[e.ROTATION=3]="ROTATION"}(a||(a={})),function(e){e[e.NONE=0]="NONE",e[e.OPACITY=1]="OPACITY",e[e.COLOR=2]="COLOR",e[e.ROTATION=4]="ROTATION",e[e.SIZE_MINMAX_VALUE=8]="SIZE_MINMAX_VALUE",e[e.SIZE_SCALE_STOPS=16]="SIZE_SCALE_STOPS",e[e.SIZE_FIELD_STOPS=32]="SIZE_FIELD_STOPS",e[e.SIZE_UNIT_VALUE=64]="SIZE_UNIT_VALUE"}(o||(o={})),function(e){e[e.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",e[e.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",e[e.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",e[e.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(u||(u={})),function(e){e[e.SPRITE=0]="SPRITE",e[e.GLYPH=1]="GLYPH"}(c||(c={}))},73271:function(e,t,r){r.d(t,{Jz:function(){return s},UJ:function(){return i}});var n=new Float32Array(1);new Uint32Array(n.buffer);function i(e,t){return 65535&e|t<<16}function s(e,t,r,n){return 255&e|(255&t)<<8|(255&r)<<16|n<<24}},36876:function(e,t,r){r.d(t,{k:function(){return _},p:function(){return m}});var n=r(37762),i=r(15671),s=r(43144),a=r(60136),o=r(29388),u=r(43244),c=r(91505),l=(r(93169),r(92026)),h=r(31581),d=r(41414),f=r(24170),v=r(5448);function p(e,t){return e<<16|t}function y(e){return(4294901760&e)>>>16}function g(e){return 65535&e}var _={getObjectId:function(e){return e.getObjectId()},getAttributes:function(e){return e.readAttributes()},getAttribute:function(e,t){return e.readAttribute(t)},cloneWithGeometry:function(e,t){return e},getGeometry:function(e){return e.readHydratedGeometry()},getCentroid:function(e,t){return e.readCentroid()}},m=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,s){var a;return(0,i.Z)(this,r),(a=t.call(this,e,n)).featureAdapter=_,a.events=new c.Z,a._featureSetsByInstance=new Map,a._objectIdToDisplayId=new Map,a._spatialIndexInvalid=!0,a._indexSearchCache=new u.Z(50),a._index=(0,h.r)(9,(function(e){return{minX:a._storage.getXMin(e),minY:a._storage.getYMin(e),maxX:a._storage.getXMax(e),maxY:a._storage.getYMax(e)}})),a._storage=n,a.mode=s,a}return(0,s.Z)(r,[{key:"storage",get:function(){return this._storage}},{key:"storeStatistics",get:function(){var e=0,t=0,r=0;return this.forEach((function(n){var i=n.readGeometry();i&&(t+=i.isPoint?1:i.lengths.reduce((function(e,t){return e+t}),0),r+=i.isPoint?1:i.lengths.length,e+=1)})),{featureCount:e,vertexCount:t,ringCount:r}}},{key:"hasInstance",value:function(e){return this._featureSetsByInstance.has(e)}},{key:"onTileData",value:function(e,t){if((0,l.Wi)(t.addOrUpdate))return t;if(t.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setComputedAttributes(this._storage,r,n,e.scale)}return t}this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate);for(var i=t.addOrUpdate.getCursor();i.next();)this._insertFeature(i,e.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),t}},{key:"search",value:function(e){var t=this;this._rebuildIndex();var r=e.id,i=this._indexSearchCache.find((function(e){return e.tileId===r}));if((0,l.pC)(i))return i.readers;var s,a=new Map,o=this._searchIndex(e.bounds),u=[],c=(0,n.Z)(o);try{for(c.s();!(s=c.n()).done;){var h=s.value,d=this._storage.getInstanceId(h),f=y(d),p=g(d);a.has(f)||a.set(f,[]),a.get(f).push(p)}}catch(_){c.e(_)}finally{c.f()}return a.forEach((function(e,r){var n=t._featureSetsByInstance.get(r);u.push(v.t.from(n,e))})),this._indexSearchCache.enqueue({tileId:r,readers:u}),u}},{key:"insert",value:function(e){for(var t=e.getCursor(),r=this._storage;t.next();){var n,i=p(t.instance,t.getIndex()),s=t.getObjectId(),a=null!=(n=this._objectIdToDisplayId.get(s))?n:this._storage.createDisplayId();t.setDisplayId(a),r.setInstanceId(a,i),this._objectIdToDisplayId.set(s,a)}this._featureSetsByInstance.set(e.instance,e),this._spatialIndexInvalid=!0}},{key:"remove",value:function(e){var t=this._objectIdToDisplayId.get(e);if(t){var r=this._storage.getInstanceId(t),n=g(r),i=y(r),s=this._featureSetsByInstance.get(i);this._objectIdToDisplayId.delete(e),this._storage.releaseDisplayId(t),s.removeAtIndex(n),s.isEmpty&&this._featureSetsByInstance.delete(i),this._spatialIndexInvalid=!0}}},{key:"forEach",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),i=t._lookupFeature(n);e(i)}))}},{key:"forEachUnsafe",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),i=y(n),s=g(n),a=t._getFeatureSet(i);a.setIndex(s),e(a)}))}},{key:"forEachInBounds",value:function(e,t){var r,i=this._searchIndex(e),s=(0,n.Z)(i);try{for(s.s();!(r=s.n()).done;){var a=r.value,o=this.lookupFeatureByDisplayId(a,this._storage);t((0,l.Wg)(o))}}catch(u){s.e(u)}finally{s.f()}}},{key:"forEachBounds",value:function(e,t,r){this._rebuildIndex();var i,s=[0,0,0,0],a=(0,n.Z)(e);try{for(a.s();!(i=a.n()).done;){var o=i.value;if(o.readGeometry()){var u=o.getDisplayId();s[0]=this._storage.getXMin(u),s[1]=this._storage.getYMin(u),s[2]=this._storage.getXMax(u),s[3]=this._storage.getYMax(u),t((0,d.JR)(r,s))}}}catch(c){a.e(c)}finally{a.f()}}},{key:"sweepFeatures",value:function(e,t,r){var n=this;this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((function(i,s){e.has(i)||(t.releaseDisplayId(i),r&&r.unsetAttributeData(i),n._objectIdToDisplayId.delete(s))})),this.events.emit("changed")}},{key:"sweepFeatureSets",value:function(e){var t=this;this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((function(r,n){e.has(n)||t._featureSetsByInstance.delete(n)}))}},{key:"lookupObjectId",value:function(e,t){var r=this.lookupFeatureByDisplayId(e,t);return(0,l.Wi)(r)?null:r.getObjectId()}},{key:"lookupDisplayId",value:function(e){return this._objectIdToDisplayId.get(e)}},{key:"lookupFeatureByDisplayId",value:function(e,t){var r=t.getInstanceId(e);return this._lookupFeature(r)}},{key:"lookupByDisplayIdUnsafe",value:function(e){var t=this._storage.getInstanceId(e),r=y(t),n=g(t),i=this._getFeatureSet(r);return i?(i.setIndex(n),i):null}},{key:"_insertFeature",value:function(e,t){var r=this._storage,n=e.getObjectId(),i=p(e.instance,e.getIndex());r.getInstanceId(e.getDisplayId());var s=this._objectIdToDisplayId.get(n);s||(s=r.createDisplayId(),this._objectIdToDisplayId.set(n,s),this._spatialIndexInvalid=!0),e.setDisplayId(s),r.setInstanceId(s,i),this.setComputedAttributes(r,e,s,t)}},{key:"_searchIndex",value:function(e){this._rebuildIndex();var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}},{key:"_rebuildIndex",value:function(){var e=this;if(this._spatialIndexInvalid){var t=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((function(r){for(var n=r.getCursor();n.next();){var i=n.getDisplayId();e._storage.setBounds(i,n)&&t.push(i)}})):this._objectIdToDisplayId.forEach((function(r){var n=e._storage.getInstanceId(r);e._storage.setBounds(r,e._lookupFeature(n))&&t.push(r)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}}},{key:"_lookupFeature",value:function(e){var t=y(e),r=g(e),n=this._getFeatureSet(t);if(!n)return null;var i=n.getCursor();return i.setIndex(r),i}},{key:"_getFeatureSet",value:function(e){return this._featureSetsByInstance.get(e)}}]),r}(f.J)},58760:function(e,t,r){r.r(t),r.d(t,{default:function(){return jt},getInstances:function(){return Ut}});var n=r(15861),i=r(15671),s=r(43144),a=r(60136),o=r(29388),u=r(87757),c=r(27366),l=r(41691),h=r(93169),d=r(49861),f=(r(63780),r(25243),r(69912)),v=r(92975),p=r(22824);function y(e){return"heatmap"===e?r.e(8896).then(r.bind(r,88896)):Promise.all([r.e(9243),r.e(0)]).then(r.bind(r,8e4))}var g=r(37762),_=r(1413),m=r(92026),k=r(75298),x=r(94172),b=r(83406),I=r(33382),w=r(52410),S=r(36876),Z=r(25899),C=r(42982),F=r(11752),T=r(61120),A=r(76200),E=r(10064),M=r(32718),O=r(18008),R=r(58971),z=r(67213),L=r(5192),q=r(3182),N=r(92010);var B=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,s){var a;return(0,i.Z)(this,r),(a=t.call(this,e,s))._featureIndex=-1,a._dateFields=new Set,a._geometryType=null==s?void 0:s.geometryType,a._features=n,a}return(0,s.Z)(r,[{key:"_current",get:function(){return this._features[this._featureIndex]}},{key:"geometryType",get:function(){return this._geometryType}},{key:"hasFeatures",get:function(){return!!this._features.length}},{key:"hasNext",get:function(){return this._featureIndex+1<this._features.length}},{key:"exceededTransferLimit",get:function(){return this._exceededTransferLimit}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"removeIds",value:function(e){var t=new Set(e);this._features=this._features.filter((function(e){return!t.has(e.objectId)}))}},{key:"append",value:function(e){var t,r=(0,g.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._features.push(n)}}catch(i){r.e(i)}finally{r.f()}}},{key:"getSize",value:function(){return this._features.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"getQuantizationTransform",value:function(){return this._transform}},{key:"getAttributeHash",value:function(){var e="";for(var t in this._current.attributes)e+=this._current.attributes[t];return e}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._featureIndex=e}},{key:"getObjectId",value:function(){return this._current.objectId}},{key:"getDisplayId",value:function(){return this._current.displayId}},{key:"setDisplayId",value:function(e){this._current.displayId=e}},{key:"getGroupId",value:function(){return this._current.groupId}},{key:"setGroupId",value:function(e){this._current.groupId=e}},{key:"copy",value:function(){var e=new r(this.instance,this._features,this.fullSchema());return this.copyInto(e),e}},{key:"next",value:function(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}},{key:"readLegacyFeature",value:function(){return(0,b.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}},{key:"readOptimizedFeature",value:function(){return this._current}},{key:"readLegacyPointGeometry",value:function(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return(0,b.di)(e,this.geometryType,this.hasZ,this.hasM)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();return(0,m.Wi)(e)?null:{x:e.coords[0]*this._sx+this._tx,y:e.coords[1]*this._sy+this._ty}}},{key:"readGeometryArea",value:function(){return(0,q.S6)(this._current)?(0,b.lz)(this._current.geometry,2):0}},{key:"readUnquantizedGeometry",value:function(){var e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;var t=e.clone();return function(e){var t,r=e.coords,n=e.lengths,i=0,s=(0,g.Z)(n);try{for(s.s();!(t=s.n()).done;){for(var a=t.value,o=1;o<a;o++)r[2*(i+o)]+=r[2*(i+o)-2],r[2*(i+o)+1]+=r[2*(i+o)-1];i+=a}}catch(u){s.e(u)}finally{s.f()}}(t),t}},{key:"readHydratedGeometry",value:function(){var e=this._current.geometry;if((0,m.Wi)(e))return null;var t=e.clone();return(0,m.pC)(this._transform)&&(0,b.$g)(t,t,this.hasZ,this.hasM,this._transform),t}},{key:"getXHydrated",value:function(){if(!(0,q.S6)(this._current))return 0;var e=this._current.geometry.coords[0],t=this.getQuantizationTransform();return(0,m.Wi)(t)?e:e*t.scale[0]+t.translate[0]}},{key:"getYHydrated",value:function(){if(!(0,q.S6)(this._current))return 0;var e=this._current.geometry.coords[1],t=this.getQuantizationTransform();return(0,m.Wi)(t)?e:t.translate[1]-e*t.scale[1]}},{key:"getX",value:function(){return(0,q.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}},{key:"getY",value:function(){return(0,q.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}},{key:"readGeometry",value:function(){if(!(0,q.S6)(this._current))return null;var e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sy+this._ty,e;var t,r=0,n=(0,g.Z)(e.lengths);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.coords[2*r]=e.coords[2*r]*this._sx+this._tx,e.coords[2*r+1]=e.coords[2*r+1]*this._sy+this._ty,r+=i}}catch(s){n.e(s)}finally{n.f()}return e}},{key:"readCentroid",value:function(){if(!(0,q.S6)(this._current))return null;if((0,m.Wi)(this._current.centroid)){var e=this._computeCentroid();if((0,m.Wi)(e))return null;e.coords[0]=(e.coords[0]-this._tx)/this._sx,e.coords[1]=(e.coords[1]-this._ty)/this._sy,this._current.centroid=e}var t=this._current.centroid.clone();return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sx+this._ty,t}},{key:"hasField",value:function(e){return e in this._current.attributes||this.getFieldNames().map((function(e){return e.toLowerCase()})).includes(e.toLowerCase())}},{key:"getFieldNames",value:function(){return Object.keys(this._current.attributes)}},{key:"_readAttribute",value:function(e,t){var r=this._current.attributes[e];if(void 0!==r)return null!=r&&t&&this._dateFields.has(e)?new Date(r):r;var n=this.readAttributes(),i=e.toLocaleLowerCase().trim();for(var s in n)if(s.toLocaleLowerCase().trim()===i){var a=this._current.attributes[s];return null!=a&&t&&this._dateFields.has(s)?new Date(a):a}}},{key:"copyInto",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}},{key:"_readAttributes",value:function(){return this._current.attributes}}],[{key:"fromFeatures",value:function(e,t){for(var n=t.objectIdField,i=t.geometryType,s=(0,b.Yn)([],e,i,!1,!1,n),a=0;a<s.length;a++)s[a].displayId=e[a].displayId;return r.fromOptimizedFeatures(s,t)}},{key:"fromFeatureSet",value:function(e,t){var n=(0,b.h_)(e,t.objectIdField);return r.fromOptimizedFeatureSet(n,t)}},{key:"fromOptimizedFeatureSet",value:function(e,t){var n=e.features,i=r.fromOptimizedFeatures(n,t);i._exceededTransferLimit=e.exceededTransferLimit,i._transform=e.transform;var s,a=(0,g.Z)(e.fields);try{for(a.s();!(s=a.n()).done;){var o=s.value;"esriFieldTypeDate"===o.type&&i._dateFields.add(o.name)}}catch(u){a.e(u)}finally{a.f()}return i}},{key:"fromOptimizedFeatures",value:function(e,t,n){var i=new r(N.s.createInstance(),e,t);return i._transform=n,i}}]),r}(N.s),D=r(70885),U=r(78084),P=r(80457),j=r(91347),G=268435455,Y=function(){function e(){(0,i.Z)(this,e),this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return(0,s.Z)(e,[{key:"hasField",value:function(e){return this.fieldMap.has(e)}},{key:"isDateField",value:function(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.isDate}},{key:"getFieldIndex",value:function(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.index}}]),e}();function W(e){for(var t=e.getLength(),r=e.pos()+t,n={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:n.name=e.getString();break;case 2:"esriFieldTypeDate"===(0,j.O7)(e.getEnum())&&(n.isDate=!0);break;default:e.skip()}return n}function X(e){return e.toLowerCase().trim()}function Q(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=1,i=3,s=9,a=12,o=13,u=15,c=e.pos(),l=new Y,h=0,d=0,f=1,v=2,p=4,y=3,g=null,_=null,m=null,k=!1;e.next();)switch(e.tag()){case n:g=e.getString();break;case i:_=e.getString();break;case a:m=e.processMessage(j.G$);break;case s:if(l.exceededTransferLimit=e.getBool(),l.exceededTransferLimit){l.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),l.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(var x=0;x<l.centroid.length;x++)l.centroid[x]=G}break;case o:var b=W(e),I=b.name,w=X(b.name),S={fieldName:I,index:h++,isDate:b.isDate};l.fields.push(S),l.fieldMap.set(b.name,S),l.fieldMap.set(w,S);break;case u:var Z=e.getLength(),C=e.pos()+Z;if(!l.exceededTransferLimit){var F=l.offsets.geometry,T=l.centroid;F.push(0),T.push(G),T.push(G)}!k&&l.exceededTransferLimit&&(k=!0,l.offsets.attributes=r?new Float64Array(8e3*h):new Uint32Array(8e3*h));for(var A=d*h;e.pos()<C&&e.next();)switch(e.tag()){case f:k?l.offsets.attributes[A++]=e.pos():l.offsets.attributes.push(e.pos());var M=e.getLength();e.skipLen(M);break;case v:if(t)for(var O=e.getLength(),R=e.pos()+O;e.pos()<R&&e.next();)if(e.tag()===y){e.getUInt32();var z=e.getSInt64(),L=e.getSInt64();l.centroid[2*d]=z,l.centroid[2*d+1]=L}else e.skip();else{l.offsets.geometry[d]=e.pos();var q=e.getLength();l.vertexCount+=q,e.skipLen(q)}break;case p:for(var N=e.getLength(),B=e.pos()+N;e.pos()<B&&e.next();)if(e.tag()===y){e.getUInt32();var D=e.getSInt64(),U=e.getSInt64();l.centroid[2*d]=D,l.centroid[2*d+1]=U}else e.skip();break;default:e.skip()}d++,l.hasFeatures=!0;break;default:e.skip()}var P=g||_;if(!P)throw new E.Z("FeatureSet has no objectId or globalId field name");return l.featureCount=d,l.fieldCount=h,l.objectIdFieldIndex=l.getFieldIndex(P),l.transform=m,l.displayIds=new Uint32Array(l.featureCount),l.groupIds=new Uint16Array(l.featureCount),e.move(c),l}var V=M.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),H=268435455,J=128e3,K={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(J),decoded:new Int32Array(J)}};function $(e){return e<=K.small.delta.length?K.small:(e<=K.large.delta.length||(K.large.delta=new Int32Array(Math.round(1.25*e)),K.large.decoded=new Int32Array(Math.round(1.25*e))),K.large)}function ee(e){return e.toLowerCase().trim()}function te(e){try{for(var t=new U.Z(new Uint8Array(e),new DataView(e));t.next();){if(2===t.tag())return re(t.getMessage());t.skip()}}catch(n){var r=new E.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:n});V.error(r)}return null}function re(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function ne(e,t,r,n,i,s){return.5*Math.abs(e*n+r*s+i*t-e*s-r*t-i*n)}function ie(e,t,r,n){return 0===e*n-r*t&&e*r+t*n>0}var se=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,s,a){var o;return(0,i.Z)(this,r),(o=t.call(this,e,a))._hasNext=!1,o._isPoints=!1,o._featureIndex=-1,o._featureOffset=0,o._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},o._geometryType=a.geometryType,o._reader=n,o._header=s,o._hasNext=s.hasFeatures,o._isPoints="esriGeometryPoint"===a.geometryType,o}return(0,s.Z)(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}},{key:"hasField",value:function(e){return this._header.hasField(e)||this._header.hasField(ee(e))}},{key:"getFieldNames",value:function(){return this._header.fields.map((function(e){return e.fieldName}))}},{key:"getSize",value:function(){return this.size}},{key:"getQuantizationTransform",value:function(){return this._header.transform}},{key:"getCursor",value:function(){return this.copy()}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}},{key:"getAttributeHash",value:function(){var e=this,t="";return this._header.fields.forEach((function(r){var n=r.index;t+=e._readAttributeAtIndex(n)+"."})),t}},{key:"getObjectId",value:function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}},{key:"getDisplayId",value:function(){return this._header.displayIds[this._featureIndex]}},{key:"setDisplayId",value:function(e){this._header.displayIds[this._featureIndex]=e}},{key:"getGroupId",value:function(){return this._header.groupIds[this._featureIndex]}},{key:"setGroupId",value:function(e){this._header.groupIds[this._featureIndex]=e}},{key:"readLegacyFeature",value:function(){if(void 0===this._cache.legacyFeature){var e,t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}},{key:"readOptimizedFeature",value:function(){if(void 0===this._cache.optFeature){var e=new q.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}},{key:"getXHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return(0,m.Wi)(t)?e:e*t.scale[0]+t.translate[0]}},{key:"getYHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return(0,m.Wi)(t)?e:t.translate[1]-e*t.scale[1]}},{key:"getX",value:function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}},{key:"getY",value:function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}},{key:"readLegacyPointGeometry",value:function(){return{x:this.getX(),y:this.getY()}}},{key:"readLegacyGeometry",value:function(e){var t=this.readGeometry(e);return(0,b.di)(t,this.geometryType,!1,!1)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();if(!e)return null;var t=(0,D.Z)(e.coords,2);return{x:t[0],y:t[1]}}},{key:"readGeometryArea",value:function(){return this._cache.area||this.readGeometry(!0),this._cache.area}},{key:"readUnquantizedGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){var t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=null,null;var r,n=$(t.coords.length).decoded,i=t.clone(n),s=i.coords,a=0,o=(0,g.Z)(i.lengths);try{for(o.s();!(r=o.n()).done;){for(var u=r.value,c=1;c<u;c++){var l=2*(a+c),h=2*(a+c-1);s[l]+=s[h],s[l+1]+=s[h+1]}a+=u}}catch(d){o.e(d)}finally{o.f()}return this._cache.unquantGeometry=i,i}return this._cache.unquantGeometry}},{key:"readHydratedGeometry",value:function(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===H)return null;var e=this.getXHydrated(),t=this.getYHydrated();return new P.Z([],[e,t])}var r=this.readGeometry();if(!r)return null;var n=r.clone(),i=this.getQuantizationTransform();return(0,m.pC)(i)&&(0,b.$g)(n,n,this.hasZ,this.hasM,i),n}},{key:"readGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){var t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===H)return null;var r=this.getX(),n=this.getY();t=new P.Z([],[r,n])}else{var i=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===i)return null;s.move(i);try{t=e?this._parseGeometryForDisplay(s):this._parseGeometry(s)}catch(a){return console.error("Failed to parse geometry!",a),null}}return this._cache.geometry=t,t}return this._cache.geometry}},{key:"readCentroid",value:function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===H?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new P.Z([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}},{key:"copy",value:function(){var e=this._reader.clone(),t=new r(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t}},{key:"next",value:function(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}},{key:"_readAttribute",value:function(e,t){var r=this._header.hasField(e)?e:ee(e),n=this._header.getFieldIndex(r);if(null!=n){var i=this._readAttributeAtIndex(n);return t?null==i?i:this._header.isDateField(r)?new Date(i):i:i}}},{key:"_readAttributes",value:function(){var e=this,t={};return this._header.fields.forEach((function(r){var n=r.fieldName,i=r.index;t[n]=e._readAttributeAtIndex(i)})),t}},{key:"copyInto",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}},{key:"_readAttributeAtIndex",value:function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}},{key:"_parseGeometry",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],i=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var s=e.getUInt32(),a=e.pos()+s;e.pos()<a;)i.push(e.getUInt32());break;case 3:var o=e.getUInt32(),u=e.pos()+o;for(n.push(e.getSInt32()+this._tx),n.push(e.getSInt32()+this._ty),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();e.pos()<u;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;default:e.skip()}return new P.Z(i,n)}},{key:"_parseGeometryForDisplay",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],i=[],s=0,a=0,o=null,u=0,c="esriGeometryPolygon"===this.geometryType;e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var l=e.getUInt32(),h=e.pos()+l;e.pos()<h;){var d=e.getUInt32();n.push(d),s+=d}o=$(2*s).delta;break;case 3:e.getUInt32();var f,v=2+(this.hasZ?1:0)+(this.hasM?1:0),p=(0,g.Z)(n);try{for(p.s();!(f=p.n()).done;){var y=f.value;if(a+v*y>o.length)for(var _=0;_<y;_++)e.getSInt32(),e.getSInt32(),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();else if(c){var m=this.getAreaSimplificationThreshold(y,this._header.vertexCount),k=2,x=1,b=e.getSInt32(),I=e.getSInt32();o[a++]=b,o[a++]=I,this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var w=e.getSInt32(),S=e.getSInt32();for(this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();k<y;){var Z=e.getSInt32(),C=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var F=b+w,T=I+S;ne(b,I,F,T,F+Z,T+C)>=m?(u+=-.5*(F-b)*(T+I),x>1&&ie(o[a-2],o[a-1],w,S)?(o[a-2]+=w,o[a-1]+=S):(o[a++]=w,o[a++]=S,x++),b=F,I=T):(Z+=w,C+=S),w=Z,S=C,k++}x<3?a-=2*x:(u+=-.5*(b+w-b)*(I+S+I),ie(o[a-2],o[a-1],w,S)?(o[a-2]+=w,o[a-1]+=S,i.push(x)):(o[a++]=w,o[a++]=S,i.push(++x)))}else{var A=0,E=e.getSInt32(),M=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),o[a++]=E,o[a++]=M,A+=1;for(var O=1;O<y;O++){var R=e.getSInt32(),z=e.getSInt32(),L=E+R,q=M+z;u+=-.5*(L-E)*(q+M),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),O>2&&ie(o[a-2],o[a-1],R,z)?(o[a-2]+=R,o[a-1]+=z):(o[a++]=R,o[a++]=z,A+=1),E=L,M=q}i.push(A)}}}catch(j){p.e(j)}finally{p.f()}break;default:e.skip()}if(this._cache.area=u,!i.length)return null;if(this._tx||this._ty){var N,B=0,D=(0,g.Z)(i);try{for(D.s();!(N=D.n()).done;){var U=N.value;o[2*B]+=this._tx,o[2*B+1]+=this._ty,B+=U}}catch(j){D.e(j)}finally{D.f()}}return new P.Z(i,o)}}],[{key:"fromBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.geometryType,s=te(e),a=Q(s,"esriGeometryPoint"===i,n),o=N.s.createInstance();return new r(o,s,a,t)}}]),r}(N.s),ae=function(){function e(t){(0,i.Z)(this,e),this.service=t}return(0,s.Z)(e,[{key:"destroy",value:function(){}}]),e}();function oe(e){var t=e.capabilities;return function(e){return e&&e.capabilities&&e.collection&&e.layerDefinition}(e.source)?new de(e):function(e){return Array.isArray(e.source)}(e)?new ce(e):t.query.supportsFormatPBF&&(0,h.Z)("featurelayer-pbf")?new le(e):new he(e)}function ue(){return(ue=(0,n.Z)(u.mark((function e(t){var r;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new O.Z,e.next=3,r.open(t,{});case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ce=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e))._portsOpen=function(e){return ue.apply(this,arguments)}(e.source).then((function(e){return n.client=e})),n}return(0,s.Z)(r,[{key:"destroy",value:function(){this.client.close(),this.client=null}},{key:"executeQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._portsOpen;case 2:return e.next=4,this.client.invoke("queryFeatures",t.toJSON(),r);case 4:return n=e.sent,e.abrupt("return",B.fromFeatureSet(n,this.service));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ae),le=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,[{key:"executeQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,L.executeQueryPBFBuffer)(this.service.source,t,r);case 2:return n=e.sent,i=n.data,s=!t.quantizationParameters,e.abrupt("return",se.fromBuffer(i,this.service,s));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ae),he=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,[{key:"executeQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c,l,h,d,f,v,p,y,g;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service,i=n.source,s=n.capabilities,a=n.spatialReference,o=n.objectIdField,c=n.geometryType,!(0,m.pC)(t.quantizationParameters)||s.query.supportsQuantization){e.next=10;break}return l=t.clone(),h=(0,R.vY)((0,m.Wg)(l.quantizationParameters)),l.quantizationParameters=null,e.next=6,(0,L.executeQuery)(i,l,a,r);case 6:return d=e.sent,f=d.data,v=(0,b.h_)(f,o),e.abrupt("return",((0,b.RZ)(h,v),B.fromOptimizedFeatureSet(v,this.service)));case 10:return e.next=12,(0,L.executeQuery)(i,t,this.service.spatialReference,r);case 12:return p=e.sent,y=p.data,"esriGeometryPoint"===c&&(y.features=null==(g=y.features)?void 0:g.filter((function(e){if((0,m.pC)(e.geometry)){var t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),e.abrupt("return",B.fromFeatureSet(y,this.service));case 16:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ae),de=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,[{key:"executeQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service.capabilities,!t.quantizationParameters||n.query.supportsQuantization){e.next=8;break}return i=t.clone(),s=(0,R.vY)((0,m.Wg)(i.quantizationParameters)),i.quantizationParameters=null,e.next=6,(0,z.WW)(this.service.source,t,r);case 6:return a=e.sent,e.abrupt("return",((0,b.RZ)(s,a),B.fromOptimizedFeatureSet(a,this.service)));case 8:return e.next=10,(0,z.WW)(this.service.source,t,r);case 10:return o=e.sent,e.abrupt("return",B.fromOptimizedFeatureSet(o,this.service));case 12:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ae),fe=r(62044),ve=r(91505),pe=r(48732),ye=r(21149),ge=r(43244),_e=function(){function e(){(0,i.Z)(this,e),this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}return(0,s.Z)(e,[{key:"unset",value:function(e){e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}},{key:"any",value:function(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}},{key:"describe",value:function(){var e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";var r,n=(0,g.Z)(this.why.mesh);try{for(n.s();!(r=n.n()).done;){var i=r.value;t+="    + ".concat(i,"\n")}}catch(c){n.e(c)}finally{n.f()}}if(this.source){e+=10,t+="-> (10) The source needs update\n";var s,a=(0,g.Z)(this.why.source);try{for(a.s();!(s=a.n()).done;){var o=s.value;t+="    + ".concat(o,"\n")}}catch(c){a.e(c)}finally{a.f()}}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");var u=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug("Applying ".concat(u," update of cost ").concat(e,"/45 ")),console.debug(t)}},{key:"toJSON",value:function(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}],[{key:"create",value:function(t){var r=new e;for(var n in t){var i=t[n];if("object"==typeof i)for(var s in i){var a=i[s];r[n][s]=a}r[n]=i}return r}},{key:"empty",value:function(){return e.create({})}},{key:"all",value:function(){return e.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}}]),e}(),me=function(){function e(t){(0,i.Z)(this,e),this.requests={done:new Array,stream:new ge.Z(10)},this._edits=null,this._abortController=new AbortController,this._done=!1,this.didSend=!1,this.tile=t}return(0,s.Z)(e,[{key:"signal",get:function(){return this._abortController.signal}},{key:"options",get:function(){return{signal:this._abortController.signal}}},{key:"empty",get:function(){return!this.requests.done.length}},{key:"edits",get:function(){return this._edits}},{key:"done",get:function(){return this._done}},{key:"end",value:function(){this._done=!0}},{key:"clear",value:function(){this.requests.done=[]}},{key:"applyUpdate",value:function(e){this.requests.done.forEach((function(t){return t.message.status.unset(e)})),(0,m.pC)(this._edits)&&this._edits.status.unset(e)}},{key:"add",value:function(e){var t;e.message.status=null!=(t=e.message.status)?t:_e.empty(),e.message.end&&this.requests.done.forEach((function(e){(0,m.pC)(e.message)&&e.message.end&&(e.message.end=!1)})),this.requests.done.push(e)}},{key:"edit",value:function(e,t){var r=e.getQuantizationTransform(),n=e.fullSchema(),i=Array.from(e.features()),s=[].concat((0,C.Z)(t),(0,C.Z)(i.map((function(e){return e.objectId}))));this.removeIds(s),this._invalidate(),(0,m.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:B.fromOptimizedFeatures(i,n,(0,m.Wg)(r)),id:this.tile.id,status:_e.empty(),end:!0}:(this.requests.done.forEach((function(e){return e.message.end=!1})),(0,m.Wg)(this._edits.addOrUpdate).append(e.features()))}},{key:"readers",value:u.mark((function e(){var t,r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,g.Z)(this.requests.done),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=11;break}if(n=r.value.message,e.t0=(0,m.pC)(n.addOrUpdate),!e.t0){e.next=9;break}return e.next=9,n.addOrUpdate;case 9:e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t1=e.catch(1),t.e(e.t1);case 16:return e.prev=16,t.f(),e.finish(16);case 19:if(e.t2=(0,m.pC)(this._edits)&&(0,m.pC)(this._edits.addOrUpdate),!e.t2){e.next=23;break}return e.next=23,this._edits.addOrUpdate;case 23:case"end":return e.stop()}}),e,this,[[1,13,16,19]])}))},{key:"_invalidate",value:function(){var e,t=(0,g.Z)(this.requests.done);try{for(t.s();!(e=t.n()).done;){e.value.message.status=_e.empty()}}catch(r){t.e(r)}finally{t.f()}(0,m.pC)(this._edits)&&(this._edits.status=_e.empty())}},{key:"removeIds",value:function(e){this._invalidate();var t,r=(0,g.Z)(this.requests.done);try{for(r.s();!(t=r.n()).done;){var n=t.value.message,i=n.addOrUpdate;(0,m.pC)(i)&&(i.removeIds(e),i.isEmpty&&(n.addOrUpdate=null))}}catch(s){r.e(s)}finally{r.f()}(0,m.pC)(this._edits)&&(0,m.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter((function(e){return e.message.addOrUpdate||e.message.end}))}},{key:"abort",value:function(){this._abortController.abort()}}]),e}();var ke,xe=function(){function e(t){(0,i.Z)(this,e),this.events=new ve.Z,this._resolver=(0,k.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=t.outSR,this._serviceInfo=t.serviceInfo,this._onTileUpdateMessage=t.onMessage}return(0,s.Z)(e,[{key:"destroy",value:function(){}},{key:"_onMessage",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._subscriptions.get(t.id)){e.next=3;break}return e.abrupt("return");case 3:return s=(0,_.Z)((0,_.Z)({},t),{},{remove:null!=(r=t.remove)?r:[],status:null!=(n=t.status)?n:_e.empty()}),e.abrupt("return",(0,k.R8)(this._onTileUpdateMessage(s,i.options)));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(e,t){var r,n=t.fields.length;t.outFields=function(e,t){var r=new Set;return e&&e.forEach((function(e){return r.add(e)})),t&&t.forEach((function(e){return r.add(e)})),r.has("*")?["*"]:Array.from(r)}(null==(r=this._schema)?void 0:r.outFields,t.outFields),t.outFields=t.outFields.length>=.75*n?["*"]:t.outFields,t.outFields.sort();var i=(0,pe.Hg)(this._schema,t);if(i){(0,h.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",i);var s="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",a={returnCentroid:(0,h.Z)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[s],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:fe.Z.fromJSON(t.timeExtent)},o=this._schema&&(0,pe.uD)(i,"outFields");this._schema&&(0,pe.V7)(i,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),o&&(e.why.source.push("Layer required fields changed"),e.source=!0),(0,pe.Hg)(a,this._queryInfo)&&(this._queryInfo=a),this._schema=t,this._resolver.resolve()}}},{key:"whenInitialized",value:function(){return this._resolver.promise}},{key:"applyUpdate",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.queryFilter||t.source&&this._didEdit)){e.next=2;break}return e.abrupt("return",(this.refresh(),void(this._didEdit=!1)));case 2:return this._subscriptions.forEach((function(e){return e.applyUpdate(t)})),e.next=5,this.resend();case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e,t=(0,g.Z)(this._tiles());try{for(t.s();!(e=t.n()).done;){var r=e.value;this.unsubscribe(r),this.subscribe(r)}}catch(n){t.e(n)}finally{t.f()}}},{key:"subscribe",value:function(e){var t=new me(e);this._subscriptions.set(e.id,t)}},{key:"unsubscribe",value:function(e){var t=this.get(e.id);(0,m.pC)(t)&&t.abort(),this._subscriptions.delete(e.id)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new ye.Z((0,_.Z)((0,_.Z)({},this._queryInfo),{},{historicMoment:t},e))}},{key:"get",value:function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}},{key:"queryLastEditDate",value:function(){var e=(0,n.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query type");case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"query",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_tiles",value:u.mark((function e(){var t,r,n,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Array.from(this._subscriptions.values()),r=0,n=t;case 2:if(!(r<n.length)){e.next=9;break}return i=n[r],e.next=6,i.tile;case 6:r++,e.next=2;break;case 9:case"end":return e.stop()}}),e,this)}))},{key:"edit",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var i,s,a,o,c,l,h=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=Array.from(this._subscriptions.values()),s=i.map((function(e){return e.tile})),a=0,o=i;a<o.length;a++)o[a].removeIds(r);if(!t.length){e.next=9;break}return c=s.map((function(e){var r=h.createTileQuery(e);return r.objectIds=t,{tile:e,query:r}})).map(function(){var e=(0,n.Z)(u.mark((function e(t){var r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.tile,n=t.query,e.t0=r,e.next=4,h.query(n);case 4:return e.t1=e.sent,e.t2=n,e.abrupt("return",{tile:e.t0,result:e.t1,query:e.t2});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=6,(0,k.WW)(c);case 6:return l=e.sent.map(function(){var e=(0,n.Z)(u.mark((function e(n){var i,s,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.tile,(s=n.result).hasFeatures||r.length||t.length){e.next=3;break}return e.abrupt("return");case 3:(a=h._subscriptions.get(i.key.id))&&a.edit(s,t);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=9,(0,k.as)(l);case 9:this._didEdit=!0;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),e}(),be=r(12502),Ie=M.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),we=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var s;return(0,i.Z)(this,r),(s=t.call(this,e)).type="feature",s.mode="on-demand",s._adapter=oe(e.serviceInfo),s._queue=new be.e({concurrency:8,process:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,k.k_)(t),!(0,m.pC)(t.tile)){e.next=8;break}return r=t.tile.key.id,n=t.signal,i=(0,h.Z)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,e.next=6,s._adapter.executeQuery(t.query,{signal:n,query:(0,_.Z)((0,_.Z)({},i),s._schema.customParameters)});case 6:return a=e.sent,e.abrupt("return",(a.level=t.tile.key.level,a));case 8:return e.abrupt("return",s._adapter.executeQuery(t.query,(0,_.Z)((0,_.Z)({},t),{},{query:s._schema.customParameters})));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),s._patchQueue=new be.e({concurrency:8,process:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,k.k_)(t),!(0,m.pC)(t.tile)){e.next=8;break}return r=t.tile.key.id,n=t.signal,i=(0,h.Z)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,e.next=6,s._adapter.executeQuery(t.query,{signal:n,query:(0,_.Z)((0,_.Z)({},i),s._schema.customParameters)});case 6:return a=e.sent,e.abrupt("return",(a.level=t.tile.key.level,a));case 8:return e.abrupt("return",s._adapter.executeQuery(t.query,(0,_.Z)((0,_.Z)({},t),{},{query:s._schema.customParameters})));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),s}return(0,s.Z)(r,[{key:"destroy",value:function(){(0,F.Z)((0,T.Z)(r.prototype),"destroy",this).call(this),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}},{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some((function(e){return!e.done}))}},{key:"maxRecordCountFactor",get:function(){return this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var e;return(null!=(e=this._serviceInfo.capabilities.query.maxRecordCount)?e:8e3)*(0,m.Pt)(this.maxRecordCountFactor,1)}},{key:"pageSize",get:function(){return Math.min(8e3,this.maxPageSize)}},{key:"enableEvent",value:function(e,t){}},{key:"subscribe",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"subscribe",this).call(this,e);var t=this._subscriptions.get(e.id);this._fetchDataTile(e).catch((function(t){(0,k.D_)(t)||Ie.error(new E.Z("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))})).then((function(){return t.end()}))}},{key:"unsubscribe",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:function(e){return this._subscriptions.get(e).readers()}},{key:"query",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._adapter.executeQuery(t,{query:this._schema.customParameters}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryLastEditDate",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._serviceInfo.source,r=(0,_.Z)((0,_.Z)({},t.query),{},{f:"json"}),e.next=3,(0,A.default)(t.path,{query:r,responseType:"json"});case 3:return e.abrupt("return",e.sent.data.editingInfo.lastEditDate);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"createTileQuery",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._serviceInfo.geometryType,i=this.createQuery(r);i.quantizationParameters=null!=(t=r.quantizationParameters)?t:e.getQuantizationParameters(),i.resultType="tile",i.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===n&&(i.maxAllowableOffset=e.resolution*(0,h.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==n&&"esriGeometryPolygon"!==n||(i.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===n&&(i.maxAllowableOffset*=(0,h.Z)("feature-polyline-generalization-factor")));var s=this._serviceInfo.capabilities.query;return i.defaultSpatialReferenceEnabled=s.supportsDefaultSpatialReference,i.compactGeometryEnabled=s.supportsCompactGeometry,i}},{key:"_executePatchQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r,n,i){var s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(s=r.clone()).outFields=[this._serviceInfo.objectIdField].concat((0,C.Z)(n)),s.returnCentroid=!1,s.returnGeometry=!1,a=(0,m.pC)(s.start)?s.start/8e3:0,o=i.signal,e.abrupt("return",this._patchQueue.push({tile:t,query:s,signal:o,depth:a}));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_resend",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,i=t.message,s=(0,m.pC)(n.outFields)?n.outFields:[],a=this._queryInfo.outFields,o=a.filter((function(e){return!s.includes(e)})),!(0,m.Wi)(i.addOrUpdate)){e.next=5;break}this._onMessage((0,_.Z)((0,_.Z)({},i),{},{type:"append"})),e.next=19;break;case 5:if(!o.length){e.next=18;break}return e.prev=6,c=this._subscriptions.get(i.id).tile,e.next=10,this._executePatchQuery(c,n,o,r);case 10:l=e.sent,(0,k.k_)(r),n.outFields=a,i.addOrUpdate.joinAttributes(l),this._onMessage((0,_.Z)((0,_.Z)({},i),{},{end:i.end,type:"append"})),e.next=16;break;case 14:e.prev=14,e.t0=e.catch(6);case 16:e.next=19;break;case 18:this._onMessage((0,_.Z)((0,_.Z)({},i),{},{type:"append"}));case 19:case"end":return e.stop()}}),e,this,[[6,14]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_resendSubscription",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.empty){e.next=2;break}return e.abrupt("return",this._onMessage({id:t.tile.id,addOrUpdate:null,end:!1,type:"append"}));case 2:r=t.signal,n=(0,g.Z)(t.requests.done),e.prev=4,n.s();case 6:if((i=n.n()).done){e.next=12;break}return s=i.value,e.next=10,this._resend(s,{signal:r});case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),n.e(e.t0);case 17:return e.prev=17,n.f(),e.finish(17);case 20:return e.abrupt("return",(0,m.pC)(t.edits)?this._onMessage(t.edits):void 0);case 21:case"end":return e.stop()}}),e,this,[[4,14,17,20]])})));return function(t){return e.apply(this,arguments)}}()},{key:"resend",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Array.from(this._subscriptions.values()),e.next=3,Promise.all(t.map((function(e){return r._resendSubscription(e)})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),r}(xe),Se=(0,h.Z)("esri-mobile"),Ze={maxDrillLevel:Se?1:4,maxRecordCountFactor:Se?1:3},Ce=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){return(0,i.Z)(this,r),t.call(this,e)}return(0,s.Z)(r,[{key:"_fetchDataTile",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,i,s,a,o,c,l=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,i=this._subscriptions.get(t.key.id),s=i.signal,a=t.getQuantizationParameters(),o=0,c=function(){var e=(0,n.Z)(u.mark((function e(n,h){var d,f,v,p,y,_,m;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=l._queryInfo,f=l.createTileQuery(n,{maxRecordCountFactor:r?Ze.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:a}),o++,e.prev=2,e.next=5,l._queue.push({tile:t,query:f,signal:s,depth:h});case 5:if(v=e.sent,o--,(0,k.k_)(s),v){e.next=8;break}return e.abrupt("return");case 8:if(d===l._queryInfo){e.next=10;break}return e.abrupt("return",void c(n,h));case 10:if(!(v.exceededTransferLimit&&h<Ze.maxDrillLevel)){e.next=14;break}p=(0,g.Z)(n.createChildTiles());try{for(p.s();!(y=p.n()).done;)_=y.value,c(_,h+1)}catch(u){p.e(u)}finally{p.f()}return e.abrupt("return");case 14:m={id:t.id,addOrUpdate:v,end:0===o,type:"append"},i.add({query:f,message:m}),l._onMessage(m),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),(0,k.D_)(e.t0)||l._onMessage({id:t.id,addOrUpdate:null,end:!0,type:"append"});case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(t,r){return e.apply(this,arguments)}}(),c(t,0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(we),Fe=r(97326),Te=r(31581),Ae=r(16889),Ee="__esri_stream_id__",Me=function(){function e(t,r,n,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;(0,i.Z)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=s,this.store=t,this.objectIdField=r,this.purgeInterval=a,this._useGeneratedIds=this.objectIdField===Ee}return(0,s.Z)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,m.Wi)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new ge.Z(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=(0,m.pC)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,i=(0,Ae.uZ)(n,0,1e3);this._trackIdToObservations.set(r,new ge.Z(i))}var s=this._trackIdToObservations.get(r).enqueue(e.objectId);(0,m.pC)(s)&&(this._addOrUpdated.has(s)?this._addOrUpdated.delete(s):this._removed.push(s))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if((0,m.pC)(t)){var i,s=(0,g.Z)(t);try{for(s.s();!(i=s.n()).done;){var a=i.value,o=this.store.removeById(a);(0,m.pC)(o)&&n.push(o)}}catch(h){s.e(h)}finally{s.f()}}if((0,m.pC)(e)){var u,c=(0,g.Z)(e);try{for(c.s();!(u=c.n()).done;){var l=u.value;l.attributes.__esri_timestamp__=r,this.store.add(l)}}catch(h){c.e(h)}finally{c.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;(0,m.pC)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r,n=(0,g.Z)(this._trackIdToObservations.values());try{for(n.s();!(r=n.n()).done;){var i=r.value;if(t>e.displayCount&&i.size){var s=(0,m.Wg)(i.dequeue());this._removed.push(s),t--}}}catch(u){n.e(u)}finally{n.f()}}if((0,m.pC)(this._trackIdLessObservations))for(var a=t-e.displayCount;a-- >0;){var o=this._trackIdLessObservations.dequeue();(0,m.pC)(o)&&this._removed.push(o)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var n=60*e.age*1e3,i=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<i&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes.__esri_timestamp__<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}(),Oe=(r(59486),r(35995)),Re=(r(75366),r(93501)),ze=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(ve.Z.EventedMixin(l.r)),Le=ze=(0,c._)([(0,f.j)("esri.layers.graphics.sources.connections.StreamConnection")],ze),qe=M.Z.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(ke||(ke={}));var Ne=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;(0,i.Z)(this,r),(n=t.call(this)).errorString=null;var s=e.geometryType,a=e.spatialReference,o=e.sourceSpatialReference;return n._config=e,n._featureZScaler=(0,Re.k)(s,o,a),n._open(),n}return(0,s.Z)(r,[{key:"_open",value:function(){var e=(0,n.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,m.pC)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if((0,m.Wi)(this._websocket))return"disconnected";switch(this._websocket.readyState){case ke.CONNECTING:case ke.OPEN:return"connected";case ke.CLOSING:case ke.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r,n,i,s,a=arguments;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:this._config.source.path,r=a.length>1&&void 0!==a[1]?a[1]:1e3,n=a.length>2&&void 0!==a[2]?a[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return i=(0,Oe.fl)(t,this._config.customParameters),e.next=9,this._createWebSocket(i);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),s=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(qe.error(new E.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return qe.error(new E.Z("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(s,"s"),e.t0)),e.next=23,(0,k.e4)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var i=new WebSocket(e);i.onopen=function(){if(i.onopen=null,t.destroyed)return i.onclose=null,void i.close();i.onclose=function(e){return t._onClose(e)},i.onerror=function(e){return t._onError(e)},i.onmessage=function(e){return t._onMessage(e)},r(i)},i.onclose=function(e){i.onopen=i.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r,n,i,s,a,o,c,l=this,h=arguments;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,r=this._websocket,!(0,m.Wi)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=(0,k.hh)(),i=r.onmessage,s=this._config,a=s.filter,o=s.outFields,c=s.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,s=null;try{s=JSON.parse(e.data)}catch(B){}s&&"object"==typeof s||(qe.error(new E.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),l.destroy()),(null==(t=s.spatialReference)?void 0:t.wkid)!==(null==c?void 0:c.wkid)&&(qe.error(new E.Z("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(c.wkid),e.data)),n.reject(),l.destroy()),"json"!==s.format&&(qe.error(new E.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),l.destroy()),a&&s.filter!==a&&qe.error(new E.Z("websocket-connection","Tried to set filter, but server doesn't support it")),o&&s.outFields!==o&&qe.error(new E.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i,n.resolve()},r.send(JSON.stringify({filter:a,outFields:o,format:"json",spatialReference:{wkid:c.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new E.Z("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=(0,g.Z)(t.features);try{for(n.s();!(r=n.n()).done;){var i=r.value;(0,m.pC)(this._featureZScaler)&&this._featureZScaler(i.geometry),this.onFeature(i)}}catch(s){n.e(s)}finally{n.f()}}catch(a){return qe.error(new E.Z("websocket-connection","Failed to parse message",a)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),qe.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&qe.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(Le);(0,c._)([(0,d.Cb)()],Ne.prototype,"connectionStatus",null),(0,c._)([(0,d.Cb)()],Ne.prototype,"errorString",void 0),Ne=(0,c._)([(0,f.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],Ne);var Be=r(77981),De=r(78952),Ue=M.Z.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),Pe={maxQueryDepth:5,maxRecordCountFactor:3},je=function(e){(0,a.Z)(c,e);var t=(0,o.Z)(c);function c(e){return(0,i.Z)(this,c),t.call(this,(0,_.Z)((0,_.Z)({},Pe),e))}return(0,s.Z)(c,[{key:"_open",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r,n,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||Ue.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,i=n.filter,s=n.outFields,this.destroyed||this._setFilter(i,s);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),(0,m.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void Ue.error(new E.Z("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,_.Z)({f:"json"},this._config.customParameters),n=(0,A.default)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return i=e.sent.data,e.abrupt("return",(this._serviceDefinition=i,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,i=r.token,s=this._inferWebSocketBaseUrl(n);return(0,Oe.fl)("".concat(s,"/subscribe"),{outSR:""+t.wkid,token:i})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=(0,g.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(-1!==n.indexOf("wss"))return n}}catch(i){r.e(i)}finally{r.f()}return Ue.error(new E.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c,l=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!((0,m.Wi)(n)||(0,m.Wi)(t)&&(0,m.Wi)(r))){e.next=3;break}return e.abrupt("return");case 3:return i=JSON.stringify({filter:this._serializeFilter(t,r)}),s=!1,a=(0,k.hh)(),o=function(){s||(l.destroyed||l._websocket!==n||Ue.error(new E.Z("geoevent-connection","Server timed out when setting filter")),a.reject())},c=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(Ue.error(new E.Z("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),a.reject(t.error)),n.onmessage=l._onMessage.bind(l),s=!0,a.resolve())},e.abrupt("return",(n.onmessage=c,n.send(i),setTimeout(o,1e4),a.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if((0,m.Wi)(e)&&(0,m.Wi)(t))return r;if((0,m.pC)(e)&&e.geometry)try{var n=(0,Be.im)(e.geometry);if("extent"!==n.type)throw new E.Z("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(i){Ue.error(new E.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",i))}return(0,m.pC)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),(0,m.pC)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return Ue.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,s=n.geometry;for(var a in i)e.attributes[a]=i[a];return s&&(e.geometry=s),e.geometry||e.centroid||Ue.error(new E.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r,n,i,s,a,o,c,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,i=this._queryRelatedFeatures(r),s=this._queryArchive(n),e.next=4,i;case 4:return e.next=6,s;case 6:if(a=e.sent){e.next=9;break}return e.abrupt("return");case 9:o=(0,g.Z)(a.features);try{for(o.s();!(c=o.n()).done;)l=c.value,this.onFeature(this._enrich(l))}catch(u){o.e(u)}finally{o.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),Ue.error(new E.Z("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=(0,n.Z)(u.mark((function e(t){var n,i,s,a,o,c,l,h,d,f,v;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(r,94990));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(i=e.sent,s=i.capabilities,a=s.query.supportsMaxRecordCountFactor,o=s.query.supportsPagination,c=s.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=n.capabilities.query.maxRecordCount,d=a?h*l:h,(f=new ye.Z).outFields=(0,m.Pt)(this._config.outFields,["*"]),f.where=(0,m.Pt)((0,m.U2)(this._config.filter,"where"),"1=1"),f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=De.Z.fromJSON(this._config.spatialReference),c&&(f.returnCentroid=!0),a&&(f.maxRecordCountFactor=l),!o){e.next=18;break}return e.abrupt("return",(f.num=d,n.destroy(),this._queryPages(t,f)));case 18:return e.next=20,(0,L.executeQuery)(t,f,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o=arguments;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>2&&void 0!==o[2]?o[2]:[],i=o.length>3&&void 0!==o[3]?o[3]:0,r.start=(0,m.pC)(r.num)?i*r.num:null,e.next=5,(0,L.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return s=e.sent,a=s.data,e.abrupt("return",a.exceededTransferLimit&&i<this._config.maxQueryDepth?(a.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,i+1)):(n.forEach((function(e){return a.features.push(e)})),a));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,i=this._serviceDefinition.relatedFeatures.joinField,s=(0,g.Z)(n);try{for(s.s();!(t=s.n()).done;){var a=t.value,o=a.attributes[i];r.set(o,a)}}catch(u){s.e(u)}finally{s.f()}this._relatedFeatures=r}}]),c}(Ne),Ge=je=(0,c._)([(0,f.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],je);function Ye(e,t){var r=e.weakClone();if((0,m.pC)(e.geometry)){var n=(0,b.Jd)(t,e.geometry.coords[0]),i=(0,b.IN)(t,e.geometry.coords[1]);r.geometry=new P.Z([],[n,i])}return r}function We(e,t){var r=(0,Te.r)(9,function(e){return"esriGeometryPoint"===e?function(e){return(0,m.pC)(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}:function(e){var t=1/0,r=1/0,n=-1/0,i=-1/0;return(0,m.pC)(e.geometry)&&e.geometry.forEachVertex((function(e,s){t=Math.min(t,e),r=Math.min(r,s),n=Math.max(n,e),i=Math.max(i,s)})),{minX:t,minY:r,maxX:n,maxY:i}}}(t));return r.load(e),r}var Xe=function(){function e(t,r){(0,i.Z)(this,e),this.onUpdate=t,this._geometryType=r,this._objectIdToFeature=new Map}return(0,s.Z)(e,[{key:"_features",get:function(){var e=[];return this._objectIdToFeature.forEach((function(t){return e.push(t)})),e}},{key:"add",value:function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}},{key:"get",value:function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}},{key:"forEach",value:function(e){this._objectIdToFeature.forEach(e)}},{key:"search",value:function(e){return this._index||(this._index=We(this._features,this._geometryType)),function(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}(this._index,e)}},{key:"removeById",value:function(e){var t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),Qe=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;(0,i.Z)(this,r),(n=t.call(this,e)).type="geoevent",n._dataReceiveEventEnabled=!1,n._level=0,n._updateInfo={websocket:0,client:0};var s=e.outSR,a=e.serviceInfo,o=a.geometryType,u=a.objectIdField,c=a.timeInfo,l=a.purgeOptions,h=a.source,d=a.spatialReference,f=a.serviceFilter,v=a.maxReconnectionAttempts,p=a.maxReconnectionInterval,y=a.updateInterval,g=a.enableDataReceived,_=a.customParameters,m=new Xe(n._onUpdate.bind((0,Fe.Z)(n)),o),k=new Me(m,u,c,l),x=function(e,t,r,n,i,s,a,o){var u=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),c={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:i,maxReconnectionAttempts:s,maxReconnectionInterval:a,customParameters:o};return u?new Ne(c):new Ge(c)}(h,d,s,o,f,v,p,_);return n._store=m,n._manager=k,n._connection=x,n._quantize=function(e){return"esriGeometryPoint"===e?Ye:function(t,r){var n=t.weakClone(),i=new P.Z,s=(0,b.Nh)(i,t.geometry,!1,!1,e,r,!1,!1);return n.geometry=s,n}}(o),n._dataReceiveEventEnabled=g,n._handles=[n._connection.on("feature",(function(e){return n._onFeature(e)})),n._connection.watch("connectionStatus",(function(e){return n.events.emit("connectionStatus",e)})),n._connection.watch("errorString",(function(e){return n.events.emit("errorString",e)}))],n._initUpdateInterval=function(){var t=performance.now();n._updateIntervalId=setInterval((function(){var r=performance.now(),i=r-t;if(i>2500){t=r;var s=Math.round(n._updateInfo.client/(i/1e3)),a=Math.round(n._updateInfo.websocket/(i/1e3));n._updateInfo.client=0,n._updateInfo.websocket=0,n.events.emit("updateRate",{client:s,websocket:a})}e.canAcceptRequest()&&n._manager.checkForUpdates()}),y)},n._initUpdateInterval(),n}return(0,s.Z)(r,[{key:"destroy",value:function(){(0,F.Z)((0,T.Z)(r.prototype),"destroy",this).call(this),this._clearUpdateInterval(),this._handles.forEach((function(e){return e.remove()})),this._connection.destroy()}},{key:"_fetchDataTile",value:function(){}},{key:"pauseStream",value:function(){this._clearUpdateInterval()}},{key:"resumeStream",value:function(){this._initUpdateInterval()}},{key:"enableEvent",value:function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}},{key:"updating",get:function(){return!1}},{key:"subscribe",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"subscribe",this).call(this,e);var t=this._subscriptions.get(e.id);this._level=e.level;var n=this._getTileFeatures(e);this._onMessage({type:"append",id:e.key.id,addOrUpdate:n,end:!0}),t.didSend=!0}},{key:"unsubscribe",value:function(e){(0,F.Z)((0,T.Z)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:u.mark((function e(t){var r,n,i,s,a;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._subscriptions.get(t),n=r.tile,e.next=3,this._getTileFeatures(n);case 3:i=(0,g.Z)(r.requests.stream.entries),e.prev=4,i.s();case 6:if((s=i.n()).done){e.next=14;break}if(a=s.value,e.t0=(0,m.pC)(a)&&(0,m.pC)(a.addOrUpdate),!e.t0){e.next=12;break}return e.next=12,a.addOrUpdate;case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(4),i.e(e.t1);case 19:return e.prev=19,i.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))},{key:"createTileQuery",value:function(e){throw new Error("Service does not support tile  queries")}},{key:"resend",value:function(){var e=(0,n.Z)(u.mark((function e(){var t=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._subscriptions.forEach((function(e){var r=e.tile,n={type:"append",id:r.id,addOrUpdate:t._getTileFeatures(r),end:!0};t._onMessage(n)}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getTileFeatures",value:function(e){var t=this,r=this._store.search(e).map((function(r){return t._quantize(r,e.transform)}));return B.fromOptimizedFeatures(r,this._serviceInfo,e.transform)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);var t=(0,b.XA)(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(r){}}},{key:"_clearUpdateInterval",value:function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}},{key:"_onUpdate",value:function(e,t){var r=this;(0,m.pC)(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach((function(e,t){e.didSend&&e.tile.level===r._level&&r._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach((function(e,t){if(e.didSend&&e.tile.level===r._level){var n=e.tile,i={type:"append",id:t,addOrUpdate:r._getTileFeatures(n),remove:[],end:!0,status:_e.empty()};e.requests.stream.enqueue(i),r._onMessage(i)}}))}}]),r}(xe),Ve=M.Z.getLogger("esri.views.2d.layers.features.sources.FeatureSource"),He=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){return(0,i.Z)(this,r),t.call(this,e)}return(0,s.Z)(r,[{key:"_fetchDataTile",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s,a,o,c,l,h,d,f,v,p=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=6,n=20,i=this._subscriptions.get(t.key.id),s=!1,a=0,o=0,c=function(e,r){o--,(0,k.k_)(i);var n=t.id,a=e.reader,u=e.query;if(!a.exceededTransferLimit){if(s=!0,0!==r&&!a.hasFeatures){var c={id:n,addOrUpdate:a,end:0===o,type:"append"};return i.add({message:c,query:u}),void p._onMessage(c)}var l={id:n,addOrUpdate:a,end:0===o,type:"append"};return i.add({message:l,query:u}),void p._onMessage(l)}var h={id:n,addOrUpdate:a,end:s&&0===o,type:"append"};i.add({message:h,query:u}),p._onMessage(h)},l=0,h=0;case 4:if(s||!(h++<n)){e.next=14;break}for(d=void 0,f=function(e){var r=a++;o++,d=p._fetchDataTilePage(t,r,i).then((function(e){return e&&c(e,r)})).catch((function(e){s=!0,(0,k.D_)(e)||(Ve.error(new E.Z("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e})),p._onMessage({id:t.id,addOrUpdate:null,end:s,type:"append"}))}))},v=0;v<l+1;v++)f();return e.next=10,d;case 10:(0,k.k_)(i),l=Math.min(l+2,r);case 12:e.next=4;break;case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchDataTilePage",value:function(){var e=(0,n.Z)(u.mark((function e(t,r,n){var i,s,a,o,c;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,k.k_)(n),i=this._queryInfo,s={start:this.pageSize*r,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()},(0,m.pC)(this.maxRecordCountFactor)&&(s.maxRecordCountFactor=this.maxRecordCountFactor),a=this.createTileQuery(t,s),e.prev=4,o=n.signal,e.next=8,this._queue.push({tile:t,query:a,signal:o,depth:r});case 8:return c=e.sent,e.abrupt("return",((0,k.k_)(n),c?i!==this._queryInfo?this._fetchDataTilePage(t,r,n):{reader:c,query:a}:null));case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("return",((0,k.H9)(e.t0),null));case 15:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(we),Je=r(84936),Ke=r(5448),$e=M.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function et(e,t,r){var n=e.getXHydrated(),i=e.getYHydrated(),s=t.getColumnForX(n),a=Math.floor(t.normalizeCol(s));return"".concat(r,"/").concat(Math.floor(t.getRowForY(i)),"/").concat(a)}function tt(e,t){if((0,m.Wi)(e))return null;var r=t.transform,n=e.getQuantizationTransform();if((0,m.Wi)(n)){var i=(0,D.Z)(r.scale,2),s=i[0],a=i[1],o=(0,D.Z)(r.translate,2),u=-o[0]/s,c=1/s,l=o[1]/a,h=1/-a;return e.transform(u,l,c,h)}var d=(0,D.Z)(n.scale,2),f=d[0],v=d[1],p=(0,D.Z)(n.translate,2),y=p[0],g=p[1],_=(0,D.Z)(r.scale,2),k=_[0],x=_[1],b=(0,D.Z)(r.translate,2),I=f/k,w=(y-b[0])/k,S=v/x,Z=(-g+b[1])/x;return e.transform(w,Z,I,S)}var rt=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e)).mode="snapshot",n._loading=!0,n._controller=new AbortController,n._downloadPromise=null,n._didSendEnd=!1,n._queries=new Array,n._invalidated=!1,n._hasAggregates=!1,n._random=new Je.Z(1e3),n._store=e.store,n._markedIdsBufId=n._store.storage.createBitset(),n}return(0,s.Z)(r,[{key:"destroy",value:function(){(0,F.Z)((0,T.Z)(r.prototype),"destroy",this).call(this),this._controller.abort()}},{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}},{key:"update",value:function(e,t){(0,F.Z)((0,T.Z)(r.prototype),"update",this).call(this,e,t),this._hasAggregates=e.targets.aggregate}},{key:"resend",value:function(){var e=(0,n.Z)(u.mark((function e(){var t,r,n,i=this,s=arguments;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]&&s[0],e.next=3,this._downloadPromise;case 3:if(!this._invalidated&&!t){e.next=11;break}return r=(0,m.s3)(this._schema.featureCount,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach((function(e){return e.clear()})),this._downloadPromise=this._download(r),e.next=10,this._downloadPromise;case 10:return e.abrupt("return",void e.sent);case 11:return n=this._queries.map((function(e){var t=e.query,r=e.reader;return i._sendPatchQuery(t,r)})),e.next=14,Promise.all(n);case 14:this._subscriptions.forEach((function(e){e.requests.done.forEach((function(e){return i._onMessage(e.message)}))}));case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=(0,n.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.resend(!0);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_sendPatchQuery",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,m.pC)(t.outFields)?t.outFields:[],i=this._queryInfo.outFields,s=i.filter((function(e){return-1===n.indexOf(e)})),s.length){e.next=3;break}return e.abrupt("return");case 3:return a=t.clone(),o=this._signal,a.returnGeometry=!1,a.returnCentroid=!1,a.outFields=s,t.outFields=i,e.next=7,this._queue.push({query:a,depth:0,signal:o});case 7:c=e.sent,(0,k.k_)({signal:o}),r.joinAttributes(c);case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchDataTile",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s,a,o,c,l,h,d;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._downloadPromise||(r=(0,m.s3)(this._schema.featureCount,"Expected featureCount to be defined"),this._downloadPromise=this._download(r)),n=this._store.search(t),i=this._subscriptions.get(t.key.id),s=n.length-1,a=0;case 3:if(!(a<s)){e.next=14;break}if(o=tt(n[a],t),c={type:"append",id:t.id,addOrUpdate:o,end:!1,status:_e.empty()},i.add({query:null,message:c}),e.t0=this._hasAggregates,e.t0){e.next=10;break}return e.next=10,(0,k.e4)(1);case 10:this._onMessage(c);case 11:a++,e.next=3;break;case 14:l=tt(s>=0?n[s]:null,t),h=this._didSendEnd,d={type:"append",id:t.id,addOrUpdate:l,end:h,status:_e.empty()},i.add({query:null,message:d}),this._onMessage(d);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_download",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s,a=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.whenInitialized();case 3:return r=this._store.storage.getBitset(this._markedIdsBufId),n=new Set,r.clear(),i=Math.ceil(t/this.pageSize),s=Array.from({length:i},(function(e,t){return t})).sort((function(e,t){return a._random.getInt()-a._random.getInt()})).map((function(e){return a._downloadPage(e,r,n)})),e.next=8,Promise.all(s);case 8:this._store.sweepFeatures(r,this._store.storage),this._store.sweepFeatureSets(n),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),$e.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",e.t0);case 15:this._sendEnd(),this._loading=!1;case 16:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_downloadPage",value:function(){var e=(0,n.Z)(u.mark((function e(t,r,n){var i,s,a,o,c,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.pageSize,s={start:t*i,num:i,cacheHint:!0},(0,m.pC)(this.maxRecordCountFactor)&&(s.maxRecordCountFactor=this.maxRecordCountFactor),a=this.createQuery(s),o=this._signal,e.next=6,this._queue.push({query:a,depth:t,signal:o});case 6:for(c=e.sent,(0,k.k_)({signal:o}),this._queries.push({query:a,reader:c}),this._store.insert(c),n.add(c.instance),l=c.getCursor();l.next();)r.set(l.getDisplayId());this._send(c);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_send",value:function(e){var t=this;if(this._subscriptions.size){var r=null,n=new Map,i=new Set,s=new Map;this._subscriptions.forEach((function(e){var t,a=e.tile;n.set(a.key.id,null),r=a.tileInfoView,i.add(a.level);var o=a.key,u=o.row,c=o.col,l="".concat(a.level,"/").concat(u,"/").concat(c),h=null!=(t=s.get(l))?t:[];h.push(e),s.set(l,h)}));var a,o=(0,g.Z)(i);try{for(o.s();!(a=o.n()).done;)for(var u=a.value,c=r.getLODInfoAt(u),l=e.getCursor();l.next();){var h=et(l,c,u),d=l.getIndex();if(s.has(h)){var f,v=(0,g.Z)(s.get(h));try{for(v.s();!(f=v.n()).done;){var p=f.value.tile.id,y=n.get(p);(0,m.Wi)(y)&&(y=[],n.set(p,y)),y.push(d)}}catch(_){v.e(_)}finally{v.f()}}}}catch(_){o.e(_)}finally{o.f()}n.forEach((function(r,n){if((0,m.pC)(r)){var i=t._subscriptions.get(n),s={type:"append",id:n,addOrUpdate:tt(Ke.t.from(e,r),i.tile),end:!1,status:_e.empty()};i.add({query:null,message:s}),t._onMessage(s)}}))}}},{key:"_sendEnd",value:function(){var e=this;this._subscriptions.forEach((function(t){var r={type:"append",id:t.tile.id,addOrUpdate:null,end:!0,status:_e.empty()};t.add({query:null,message:r}),e._onMessage(r)})),this._didSendEnd=!0}}]),r}(we);function nt(e,t,r,n,i,s){var a=function(e,t,r,n,i,s){switch(e.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,m.Pt)(e.featureCount,0),serviceInfo:e,onMessage:n,outSR:t,tileInfoView:r,canAcceptRequest:i,store:s};case"stream":return{type:"geoevent",serviceInfo:e,onMessage:n,outSR:t,canAcceptRequest:i};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onMessage:n,outSR:t,origin:a(e.source),tileInfoView:r,canAcceptRequest:i}}function a(e){return Array.isArray(e)?"local":"path"in e&&(0,Z.M8)(e.path)?"hosted":"unknown"}}(e,t,r,n,i,s);switch(a.type){case"feature":switch(a.origin){case"hosted":case"local":return new He(a);case"snapshot":return new rt(a);case"unknown":return new Ce(a)}case"geoevent":return new Qe(a)}}var it=r(94109),st=r(84328),at=r(46640);r(65800),r(80613),M.Z.getLogger("esri.views.2d.engine.webgl");var ot=r(8548),ut=M.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),ct=function(e,t){return e&&function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.warn.apply(t,["DEBUG:"].concat(r))}||function(){return null}}(!1,ut),lt={sharedArrayBuffer:(0,h.Z)("esri-shared-array-buffer"),atomics:(0,h.Z)("esri-atomics")};function ht(e,t){return function(r){return t(e(r))}}var dt=function(){function e(t,r,n,s){(0,i.Z)(this,e),this.size=0,this.texelSize=4;var a=s.pixelType,o=s.layout,u=s.textureOnly;this.textureOnly=u||!1,this.pixelType=a,this._ctype=r,this.layout=o,this._resetRange(),this._shared=t,this.size=n,u||(this.data=this._initData(a,n,t,r))}return(0,s.Z)(e,[{key:"buffer",get:function(){return(0,m.yw)(this.data,(function(e){return e.buffer}))}},{key:"unsetComponentAllTexels",value:function(e,t){for(var r=(0,m.Wg)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponentAllTexels",value:function(e,t){for(var r=(0,m.Wg)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponent",value:function(e,t,r){var n,i=(0,m.Wg)(this.data),s=(0,g.Z)(r);try{for(s.s();!(n=s.n()).done;){var a=n.value;i[a*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a)}}catch(o){s.e(o)}finally{s.f()}}},{key:"setComponentTexel",value:function(e,t,r){(0,m.Wg)(this.data)[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"unsetComponentTexel",value:function(e,t,r){(0,m.Wg)(this.data)[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"getData",value:function(e,t){var r=(0,st.jL)(e);return(0,m.Wg)(this.data)[r*this.texelSize+t]}},{key:"setData",value:function(e,t,r){var n=(0,st.jL)(e),i=1<<t;0!=(this.layout&i)?(this.data[n*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)):ut.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}},{key:"lock",value:function(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&lt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}},{key:"unlock",value:function(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&lt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}},{key:"expand",value:function(e){if(this.size=e,!this.textureOnly){var t=this._initData(this.pixelType,e,this._shared,this._ctype),r=(0,m.Wg)(this.data);t.set(r),this.data=t}}},{key:"toMessage",value:function(){var e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();var n=!(this._shared||"local"===this._ctype),i=this.pixelType,s=this.layout,a=(0,m.Wg)(this.data);return{start:e,end:t,data:n&&a.slice(e*r,(t+1)*r)||null,pixelType:i,layout:s}}},{key:"_initData",value:function(e,t,r,n){for(var i=r&&"local"!==n?SharedArrayBuffer:ArrayBuffer,s=(0,at.UK)(e),a=new s(new i(t*t*4*s.BYTES_PER_ELEMENT)),o=0;o<a.length;o+=4)a[o+1]=255;return a}},{key:"_resetRange",value:function(){this.dirtyStart=2147483647,this.dirtyEnd=0}}]),e}(),ft=function(){function e(t,r){(0,i.Z)(this,e),this._client=t,this.config=r,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(it.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;var n=r.supportsTextureFloat?ot.Br.FLOAT:ot.Br.UNSIGNED_BYTE;ct("Creating AttributeStore ".concat(lt.sharedArrayBuffer?"with":"without"," shared memory")),this._blockDescriptors=[{pixelType:ot.Br.UNSIGNED_BYTE,layout:1},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:n,layout:15},{pixelType:n,layout:15}],this._blocks=this._blockDescriptors.map((function(){return null}))}return(0,s.Z)(e,[{key:"destroy",value:function(){this._abortController.abort()}},{key:"hasScaleExpr",get:function(){return this._hasScaleExpr}},{key:"_signal",get:function(){return this._abortController.signal}},{key:"hasHighlight",get:function(){return this._idsToHighlight.size>0}},{key:"update",value:function(e,t){this.config=t;var r=t.schema.processors[0].storage,n=(0,pe.Hg)(this._schema,r);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),n&&((0,h.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",n),e.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!(0,m.Wi)(r))){switch(r.target){case"feature":this._targetType=st.PX;break;case"aggregate":this._targetType=st.xp}if("subtype"===r.type)for(var i in r.mapping){var s=r.mapping[i];if((0,m.pC)(s)){var a,o=(0,g.Z)(s.mapping);try{for(o.s();!(a=o.n()).done;){var u=a.value;this._bindAttribute(u)}}catch(f){o.e(f)}finally{o.f()}}}else{var c,l=(0,g.Z)(r.mapping);try{for(l.s();!(c=l.n()).done;){var d=c.value;this._bindAttribute(d)}}catch(f){l.e(f)}finally{l.f()}}}}},{key:"onTileData",value:function(e,t){if(!(0,m.Wi)(t.addOrUpdate))for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setAttributeData(n,r)}}},{key:"invalidateResources",value:function(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}},{key:"setHighlight",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:1,n=this._getBlock(0),i=r.map((function(e){return(0,st.jL)(e)})),n.lock(),n.unsetComponentAllTexels(0,1),n.setComponent(0,1,i),n.unlock(),this._idsToHighlight.clear(),s=(0,g.Z)(t);try{for(s.s();!(a=s.n()).done;)o=a.value,this._idsToHighlight.add(o)}catch(u){s.e(u)}finally{s.f()}return e.next=6,this.sendUpdates();case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateFilters",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.config,i=r.service,s=r.spatialReference,a=n.filters,o=a.map((function(e,t){return c._updateFilter(e,t,i,s)})),e.next=3,Promise.all(o);case 3:if(e.t0=e.sent.some((function(e){return e})),!e.t0){e.next=6;break}t.storage.filters=!0,(0,h.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed");case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setData",value:function(e,t,r,n){var i=(0,st.jL)(e);this._ensureSizeForTexel(i),this._getBlock(t).setData(e,r,n)}},{key:"getData",value:function(e,t,r){return this._getBlock(t).getData(e,r)}},{key:"getHighlightFlag",value:function(e){return this._idsToHighlight.has(e)?it.uG:0}},{key:"unsetAttributeData",value:function(e){var t=(0,st.jL)(e);this._getBlock(0).setData(t,0,0)}},{key:"setAttributeData",value:function(e,t){var r=this,n=(0,st.jL)(e);if(this._ensureSizeForTexel(n),this._getBlock(0).setData(n,0,this.getFilterFlags(t)),this._targetType===(0,st.vs)(e)){var i=this._attributeComputeMap,s=this.config.supportsTextureFloat?1:2;i.size&&i.forEach((function(e,i){var a=i*s%4,o=Math.floor(i*s/4),u=r._getBlock(o+it.aK),c=e(t);if(r.config.supportsTextureFloat)u.setData(n,a,c);else if(c===it.AI)u.setData(n,a,255),u.setData(n,a+1,255);else{var l=(0,Ae.uZ)(Math.round(c),-32767,32766)+32768,h=255&l,d=(65280&l)>>8;u.setData(n,a,h),u.setData(n,a+1,d)}}))}}},{key:"sendUpdates",value:function(){var e=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,k.hh)(),this._nextUpdate.promise;var t={blocks:this._blocks.map((function(e){return(0,m.pC)(e)?e.toMessage():null}))};return this._currUpdate=this._createResources().then((function(){var r=function(){if(e._currUpdate=null,e._nextUpdate){var t=e._nextUpdate;e._nextUpdate=null,e.sendUpdates().then((function(){return t.resolve()}))}},n=e._client.update(t,e._signal).then(r).catch(r);return e._client.render(e._signal),n})).catch((function(t){return(0,k.D_)(t)?(e._createResourcesPromise=null,e._createResources()):(ut.error(new E.Z("mapview-attribute-store","Encountered an error during client update",t)),Promise.resolve())})),this._currUpdate}},{key:"_ensureSizeForTexel",value:function(e){for(;e>=this._size*this._size;)if(this._expand())return}},{key:"_bindAttribute",value:function(e){var t;if(null!=e.fieldIndex)e.normalizationField&&ut.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=function(t){return t.getComputedNumericAtIndex(e.fieldIndex)};else{if(!e.field)return;t=e.normalizationField?function(t){var r=t.readAttribute(e.normalizationField);return r?t.readAttribute(e.field)/r:null}:function(t){return t.readAttribute(e.field)}}e.valueRepresentation&&(t=ht(t,(function(t){return function(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}(t,e.valueRepresentation)})));this._attributeComputeMap.set(e.binding,ht(t,(function(e){return null===e||isNaN(e)||e===1/0?it.AI:e})))}},{key:"_createResources",value:function(){var e=this;if((0,m.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(it.xl),this._getBlock(it.pU),ct("Initializing AttributeStore");var t={shared:lt.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:(0,m.Fd)(this._blocks,(function(e){return{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}}))},r=this._client.initialize(t,this._signal).catch((function(t){(0,k.D_)(t)?e._createResourcesPromise=null:ut.error(new E.Z("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=r,r.then((function(){return(0,m.Wi)(e._createResourcesPromise)?e._createResources():void 0})),r}},{key:"_getBlock",value:function(e){var t=this._blocks[e];if((0,m.pC)(t))return t;ct("Initializing AttributeBlock at index ".concat(e));var r=lt.sharedArrayBuffer,n=this._client.type,i=new dt(r,n,this._size,this._blockDescriptors[e]);return this._blocks[e]=i,this._createResourcesPromise=null,i}},{key:"_expand",value:function(){if(this._size<this.config.maxTextureSize){var e=this._size<<=1;return ct("Expanding block size to",e,this._blocks),(0,m.JR)(this._blocks,(function(t){return t.expand(e)})),this._createResourcesPromise=null,this._size=e,0}return ut.error(new E.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}},{key:"_updateFilter",value:function(){var e=(0,n.Z)(u.mark((function e(t,r,n,i){var s,a,o,c,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this._filters[r],a=(0,m.pC)(s)&&s.hash,s||t){e.next=3;break}return e.abrupt("return",!1);case 3:if(a!==JSON.stringify(t)){e.next=5;break}return e.abrupt("return",!1);case 5:if(!(0,m.Wi)(t)){e.next=10;break}if(s){e.next=8;break}return e.abrupt("return",!1);case 8:return o=1<<r+1,c=this._getBlock(0),e.abrupt("return",(this._filters[r]=null,c.setComponentAllTexels(0,o),this.sendUpdates(),!0));case 10:return e.next=12,this._getFilter(r,n);case 12:return l=e.sent,e.next=15,l.update(t,i);case 15:return e.abrupt("return",!0);case 16:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getFilter",value:function(){var e=(0,n.Z)(u.mark((function e(t,n){var i,s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._filters[t],!(0,m.pC)(i)){e.next=3;break}return e.abrupt("return",i);case 3:return e.next=5,r.e(7481).then(r.bind(r,37481));case 5:return s=e.sent,a=s.default,o=new a({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:new w.Z(n.fields)}),e.abrupt("return",(this._filters[t]=o,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"isVisible",value:function(e){return!!(2&this._getBlock(0).getData(e,0))}},{key:"getFilterFlags",value:function(e){for(var t=0,r=(0,st.KS)(e.getDisplayId()),n=0;n<this._filters.length;n++){var i=!!(r&1<<n),s=this._filters[n];t|=(!i||(0,m.Wi)(s)||s.check(e)?1:0)<<n}var a=0;if(this._idsToHighlight.size){var o=e.getObjectId();a=this.getHighlightFlag(o)}return t<<1|a}}]),e}();new Float64Array(2),new Float64Array(2);function vt(e,t,r,n){n%2&&(n+=1);for(var i=0,s=0,a=-90,o=90,u=-180,c=180,l=0;l<n/2;l++){for(var h=0;h<5;h++){var d=(u+c)/2,f=r>d?1:0;i|=f<<29-(h+5*l),u=(1-f)*u+f*d,c=(1-f)*d+f*c}for(var v=0;v<5;v++){var p=(a+o)/2,y=t>p?1:0;s|=y<<29-(v+5*l),a=(1-y)*a+y*p,o=(1-y)*p+y*o}}e.geohashX=i,e.geohashY=s}function pt(e,t,r,n,i){i%2&&(i+=1);for(var s=0,a=0,o=-90,u=90,c=-180,l=180,h=0;h<i/2;h++){for(var d=0;d<5;d++){var f=(c+l)/2,v=n>f?1:0;s|=v<<29-(d+5*h),c=(1-v)*c+v*f,l=(1-v)*f+v*l}for(var p=0;p<5;p++){var y=(o+u)/2,g=r>y?1:0;a|=g<<29-(p+5*h),o=(1-g)*o+g*y,u=(1-g)*y+g*u}}e[2*t]=s,e[2*t+1]=a}var yt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8096;(0,i.Z)(this,e),this._nodes=0,this._root=new gt(0,0,0),this._statisticFields=t,this._pool=n?new ge.Z(8096):null,this._serviceInfo=r}return(0,s.Z)(e,[{key:"_acquire",value:function(e,t,r){this._nodes++;var n=null;return(0,m.pC)(this._pool)&&(n=this._pool.dequeue()),(0,m.pC)(n)?n.realloc(e,t,r):new gt(e,t,r)}},{key:"_release",value:function(e){this._nodes--,(0,m.pC)(this._pool)&&this._pool.enqueue(e)}},{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return(0,m.R2)(this._pool,0,(function(e){return e.size}))}},{key:"depth",get:function(){var e=0;return this._forEachNode((function(t){return e=Math.max(e,t.depth)})),e}},{key:"dropLevels",value:function(e){var t=this;this._forEachNode((function(r){if(r.depth>=e)for(var n=0;n<r.children.length;n++){var i=r.children[n];r.children[n]=null,i&&t._release(i)}}))}},{key:"clear",value:function(){this.dropLevels(0)}},{key:"insert",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=B.fromOptimizedFeatures([e],this._serviceInfo).getCursor();n.next();var i=n.readGeometry();if(i){var s=(0,D.Z)(i.coords,2),a=s[0],o=s[1],u=e.geohashX,c=e.geohashY;this.insertCursor(n,e.displayId,a,o,u,c,t,r)}}},{key:"insertCursor",value:function(e,t,r,n,i,s,a){for(var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=this._root,c=0,l=0,h=0;null!==u;){if(u.depth>=o&&(u.count+=1,u.xTotal+=r,u.yTotal+=n,u.xGeohashTotal+=i,u.yGeohashTotal+=s,u.displayId=t,this._updateStatisticsCursor(e,u,1)),c>=a)return void u.add(t);var d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),v=1-c%2,p=30-(3*d+2*f),y=30-(2*d+3*f),g=(i&7*v+3*(1-v)<<p)>>p,_=(s&3*v+7*(1-v)<<y)>>y,m=g+_*(8*v+4*(1-v));l=l<<3*v+2*(1-v)|g,h=h<<2*v+3*(1-v)|_,null==u.children[m]&&(u.children[m]=this._acquire(l,h,c+1)),c+=1,u=u.children[m]}}},{key:"remove",value:function(e,t){var r=B.fromOptimizedFeatures([e],this._serviceInfo).getCursor();r.next();var n=r.readGeometry();if(n){var i=(0,D.Z)(n.coords,2),s=i[0],a=i[1],o=e.geohashX,u=e.geohashY;this.removeCursor(r,s,a,o,u,t)}}},{key:"removeCursor",value:function(e,t,r,n,i,s){for(var a=this._root,o=0;null!==a;){if(a.count-=1,a.xTotal-=t,a.yTotal-=r,a.xGeohashTotal-=n,a.yGeohashTotal-=i,this._updateStatisticsCursor(e,a,-1),o>=s)return void a.remove(e.getDisplayId());var u=Math.ceil((o+1)/2),c=Math.floor((o+1)/2),l=1-o%2,h=30-(3*u+2*c),d=30-(2*u+3*c),f=((n&7*l+3*(1-l)<<h)>>h)+((i&3*l+7*(1-l)<<d)>>d)*(8*l+4*(1-l)),v=a.children[f];1===v.count&&(this._release(v),a.children[f]=null),o+=1,a=v}}},{key:"find",value:function(e,t,r){return this._root.find(e,t,r,0,0,0)}},{key:"findSingleOccupancyNode",value:function(e,t,r,n,i){for(var s=this._root;null!==s;){var a=s.depth,o=s.xNode,u=s.yNode,c=1-a%2,l=s.xGeohashTotal/s.count,h=s.yGeohashTotal/s.count;if(1===s.count&&e<l&&l<=r&&t<h&&h<=n)return s;if(a>=i)s=s.next;else{for(var d=Math.ceil((a+1)/2),f=Math.floor((a+1)/2),v=30-(3*d+2*f),p=30-(2*d+3*f),y=~((1<<v)-1),g=~((1<<p)-1),_=(e&y)>>v,m=(t&g)>>p,k=(r&y)>>v,x=(n&g)>>p,b=o<<3*c+2*(1-c),I=u<<2*c+3*(1-c),w=b+8*c+4*(1-c),S=I+4*c+8*(1-c),Z=Math.max(b,_),C=Math.max(I,m),F=Math.min(w,k),T=Math.min(S,x),A=null,E=null,M=C;M<=T;M++)for(var O=Z;O<=F;O++){var R=O-b+(M-I)*(8*c+4*(1-c)),z=s.children[R];z&&(A||((A=z).next=s.next),E&&(E.next=z),E=z,z.next=s.next)}s=A||s.next}}return null}},{key:"getRegionDisplayIds",value:function(e,t,r,n,i){for(var s=this._root,a=[];null!==s;){var o=s.depth,u=s.xNode,c=s.yNode;if(o>=i){var l=s.xGeohashTotal/s.count,h=s.yGeohashTotal/s.count;e<=l&&l<=r&&t<=h&&h<=n&&s.displayIds.forEach((function(e){return a.push(e)})),s=s.next}else{for(var d=Math.ceil((o+1)/2),f=Math.floor((o+1)/2),v=1-o%2,p=30-(3*d+2*f),y=30-(2*d+3*f),g=~((1<<p)-1),_=~((1<<y)-1),m=(e&g)>>p,k=(t&_)>>y,x=(r&g)>>p,b=(n&_)>>y,I=u<<3*v+2*(1-v),w=c<<2*v+3*(1-v),S=I+8*v+4*(1-v),Z=w+4*v+8*(1-v),C=Math.max(I,m),F=Math.max(w,k),T=Math.min(S,x),A=Math.min(Z,b),E=null,M=null,O=F;O<=A;O++)for(var R=C;R<=T;R++){var z=R-I+(O-w)*(8*v+4*(1-v)),L=s.children[z];L&&(E||((E=L).next=s.next),M&&(M.next=L),M=L,L.next=s.next)}s=E||s.next}}return a}},{key:"getRegionStatistics",value:function(e,t,r,n,i){for(var s=this._root,a=0,o=0,u=0,c={},l=0;null!==s;){var h=s.depth,d=s.xNode,f=s.yNode;if(h>=i){var v=s.xGeohashTotal/s.count,p=s.yGeohashTotal/s.count;e<v&&v<=r&&t<p&&p<=n&&(a+=s.count,o+=s.xTotal,u+=s.yTotal,1===s.count&&(l=s.displayId),this._aggregateStatistics(c,s.statistics)),s=s.next}else{for(var y=Math.ceil((h+1)/2),g=Math.floor((h+1)/2),_=1-h%2,m=30-(3*y+2*g),k=30-(2*y+3*g),x=~((1<<m)-1),b=~((1<<k)-1),I=(e&x)>>m,w=(t&b)>>k,S=(r&x)>>m,Z=(n&b)>>k,C=d<<3*_+2*(1-_),F=f<<2*_+3*(1-_),T=C+8*_+4*(1-_),A=F+4*_+8*(1-_),E=Math.max(C,I),M=Math.max(F,w),O=Math.min(T,S),R=Math.min(A,Z),z=null,L=null,q=M;q<=R;q++)for(var N=E;N<=O;N++){var B=N-C+(q-F)*(8*_+4*(1-_)),D=s.children[B];if(D){if(q!==M&&q!==R&&N!==E&&N!==O){var U=D.xGeohashTotal/D.count,P=D.yGeohashTotal/D.count;e<U&&U<=r&&t<P&&P<=n&&(a+=D.count,o+=D.xTotal,u+=D.yTotal,1===D.count&&(l=D.displayId),this._aggregateStatistics(c,D.statistics));continue}z||((z=D).next=s.next),L&&(L.next=D),L=D,D.next=s.next}}s=z||s.next}}return{count:a,attributes:this._normalizeStatistics(c,a),xTotal:o,yTotal:u,referenceId:l}}},{key:"_forEachNode",value:function(e){for(var t=this._root;null!==t;){var r=this._linkChildren(t)||t.next;e(t),t=r}}},{key:"_linkChildren",value:function(e){for(var t=null,r=null,n=0;n<=e.children.length;n++){var i=e.children[n];i&&(t||((t=i).next=e.next),r&&(r.next=i),r=i,i.next=e.next)}return t}},{key:"_updateStatisticsCursor",value:function(e,t,r){var n,i=(0,g.Z)(this._statisticFields);try{for(i.s();!(n=i.n()).done;){var s=n.value,a=s.name,o=s.inField?e.readAttribute(s.inField):e.getComputedNumericAtIndex(s.inFieldIndex);switch(s.statisticType){case"norm":t.statistics[a]||(t.statistics[a]={});var u=s.inNormalizationField,c=e.readAttribute(u),l=t.statistics[a].onStatisticField||0,h=t.statistics[a].onStatisticNormalizationField||0;null==o||isNaN(o)||null==c||0===c||isNaN(c)||(t.statistics[a].onStatisticField=l+r*o,t.statistics[a].onStatisticNormalizationField=h+r*c);break;case"sum":case"avg":t.statistics[a]||(t.statistics[a]={value:0,nanCount:0});var d=t.statistics[a].value,f=t.statistics[a].nanCount;null==o||isNaN(o)?t.statistics[a].nanCount=f+r:t.statistics[a].value=d+r*o;break;case"avg_angle":t.statistics[a]||(t.statistics[a]={x:0,y:0,nanCount:0});var v=t.statistics[a].x,p=t.statistics[a].y,y=t.statistics[a].nanCount,_=Math.PI/180;null==o||isNaN(o)?t.statistics[a].nanCount=y+r:(t.statistics[a].x=v+r*Math.cos(o*_),t.statistics[a].y=p+r*Math.sin(o*_));break;case"mode":t.statistics[a]||(t.statistics[a]={});var m=t.statistics[a][o]||0;t.statistics[a][o]=m+r}}}catch(k){i.e(k)}finally{i.f()}}},{key:"_aggregateStatistics",value:function(e,t){var r,n=(0,g.Z)(this._statisticFields);try{for(n.s();!(r=n.n()).done;){var i=r.value,s=i.name;switch(i.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var a in e[s]||(e[s]={}),t[s]){var o=e[s][a]||0;e[s][a]=o+t[s][a]}}}}catch(u){n.e(u)}finally{n.f()}}},{key:"_normalizeStatistics",value:function(e,t){var r,n={},i=(0,g.Z)(this._statisticFields);try{for(i.s();!(r=i.n()).done;){var s=r.value,a=s.name;switch(s.statisticType){case"norm":var o=e[a];if(t&&null==o.onStatisticNormalizationField)break;if(t&&o.onStatisticNormalizationField){n[a]=o.onStatisticField/o.onStatisticNormalizationField;break}n[a]=0;break;case"sum":if(!t)break;var u=e[a],c=u.value;if(!(t-u.nanCount))break;n[a]=c;break;case"avg":if(!t)break;var l=e[a],h=l.value,d=l.nanCount;if(!(t-d))break;n[a]=h/(t-d);break;case"avg_angle":if(!t)break;var f=e[a],v=f.x,p=f.y,y=f.nanCount;if(!(t-y))break;var _=v/(t-y),m=p/(t-y),k=180/Math.PI,x=Math.atan2(m,_)*k;n[a]=x;break;case"mode":var b=e[a],I=0,w=null;for(var S in b){var Z=b[S];Z>I&&(I=Z,w=S)}n[a]="null"===w?null:w}}}catch(C){i.e(C)}finally{i.f()}return n}}]),e}(),gt=function(){function e(t,r,n){(0,i.Z)(this,e),this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var s=0;s<this.children.length;s++)this.children[s]=null;this.xNode=t,this.yNode=r,this.depth=n}return(0,s.Z)(e,[{key:"realloc",value:function(e,t,r){for(var n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}},{key:"add",value:function(e){this.displayIds.add(e)}},{key:"remove",value:function(e){this.displayIds.delete(e)}},{key:"getLngLatBounds",value:function(){var e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),n=30-(3*t+2*r),i=30-(2*t+3*r);return function(e,t){for(var r=-90,n=90,i=-180,s=180,a=0;a<t;a++){for(var o=Math.ceil((a+1)/2),u=Math.floor((a+1)/2),c=1-a%2,l=30-(3*o+2*u),h=30-(2*o+3*u),d=3*c+2*(1-c),f=2*c+3*(1-c),v=3*c+7*(1-c)<<h,p=(7*c+3*(1-c)<<l&e.geohashX)>>l,y=(v&e.geohashY)>>h,g=d-1;g>=0;g--){var _=(i+s)/2,m=p&1<<g?1:0;i=(1-m)*i+m*_,s=(1-m)*_+m*s}for(var k=f-1;k>=0;k--){var x=(r+n)/2,b=y&1<<k?1:0;r=(1-b)*r+b*x,n=(1-b)*x+b*n}}return[i,r,s,n]}({geohashX:this.xNode<<n,geohashY:this.yNode<<i},this.depth)}},{key:"find",value:function(e,t,r,n,i,s){if(n>=r)return this;var a=1-n%2,o=3*a+2*(1-a),u=2*a+3*(1-a),c=30-i-o,l=30-s-u,h=((e&7*a+3*(1-a)<<c)>>c)+((t&3*a+7*(1-a)<<l)>>l)*(8*a+4*(1-a)),d=this.children[h];return null==d?null:d.find(e,t,r,n+1,i+o,s+u)}}]),e}(),_t=r(22186),mt=r(19995),kt=r(24170),xt=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,s,a,o){var u;return(0,i.Z)(this,r),(u=t.call(this,new P.Z([],[n,s]),a,null,e)).geohashBoundsInfo=o,u}return(0,s.Z)(r,[{key:"count",get:function(){return this.attributes.cluster_count}},{key:"update",value:function(e,t,r,n,i,s){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=n,this.geohashBoundsInfo=i,this.referenceId=null,this.referenceId=s,this}},{key:"toJSON",value:function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:(0,_.Z)((0,_.Z)({},this.attributes),{},{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}],[{key:"create",value:function(e,t,n,i,s,a,o,u){var c=new r(t,n,i,a,o);return c.displayId=e.createDisplayId(!0),c.referenceId=u,c.tileLevel=s,c}}]),r}(q.nd);function bt(e){return 57.29577951308232*e}var It=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e,n,s,a){var o;return(0,i.Z)(this,r),(o=t.call(this,e,s)).events=new ve.Z,o._geohashLevel=0,o._tileLevel=0,o._aggregateValueRanges={},o._aggregateValueRangesChanged=!1,o._geohashBuf=[],o._clusters=new Map,o._tiles=new Map,o._serviceInfo=a,o.geometryInfo=e.geometryInfo,o._spatialReference=n,o._projectionSupportCheck=(0,mt._W)(n,De.Z.WGS84),o._bitsets.geohash=s.getBitset(s.createBitset()),o._bitsets.inserted=s.getBitset(s.createBitset()),o}return(0,s.Z)(r,[{key:"updateSchema",value:function(){var e=(0,n.Z)(u.mark((function e(t,n){var i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._schema,e.prev=1,e.next=4,(0,F.Z)((0,T.Z)(r.prototype),"updateSchema",this).call(this,t,n);case 4:return e.next=6,this._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:s=(0,pe.Hg)(i,n),n&&(!(0,m.Wi)(s)||t.source||t.storage.filters)?(((0,pe.uD)(s,"params.fields")||!this._tree||t.source)&&(this._tree=new yt(this._statisticFields,this._serviceInfo),this._rebuildTree(),(0,h.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,h.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",s),t.targets[n.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):i&&(t.mesh=!0);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"clear",value:function(){this._rebuildTree()}},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var i=t.lookupByDisplayIdUnsafe(n);r._remove(i)}}))}},{key:"sweepClusters",value:function(e,t,r){var n=this;this._clusters.forEach((function(i,s){i&&i.tileLevel!==r&&(e.releaseDisplayId(i.displayId),t.unsetAttributeData(i.displayId),n._clusters.delete(s))}))}},{key:"onTileData",value:function(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!this._schema||(0,m.Wi)(t.addOrUpdate))return t;for(var s=this._getTransforms(e,this._spatialReference),a=t.addOrUpdate.getCursor();a.next();)this._update(a,n);if(t.status.mesh||!i)return t;var o=new Array,u=this._schema.params.clusterRadius;this._getClustersForTile(o,e,u,r,s),t.addOrUpdate=B.fromOptimizedFeatures(o,this._serviceInfo),t.addOrUpdate.attachStorage(r),t.end=!0;for(var c=t.addOrUpdate.getCursor();c.next();){var l=c.getDisplayId();this._bitsets.computed.unset(l),this.setComputedAttributes(r,c,l,e.scale)}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}},{key:"onTileUpdate",value:function(e){var t=this,r=e.added,n=e.removed;if(r.length){var i=r[0].level;this._tileLevel=i,this._setGeohashLevel(i)}if(this._schema){var s=this._schema.params.clusterRadius;n.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,s)}))}}},{key:"getAggregate",value:function(e){var t,r=(0,g.Z)(this._clusters.values());try{for(r.s();!(t=r.n()).done;){var n=t.value;if(((null==n?void 0:n.displayId)&st._I)==(e&st._I))return n.toJSON()}}catch(i){r.e(i)}finally{r.f()}return null}},{key:"getAggregates",value:function(){var e,t=[],r=(0,g.Z)(this._clusters.values());try{for(r.s();!(e=r.n()).done;){var n=e.value;(null==n?void 0:n.tileLevel)===this._tileLevel&&t.push(n.toJSON())}}catch(i){r.e(i)}finally{r.f()}return t}},{key:"getDisplayId",value:function(e){var t=this._clusters.get(e);return t?t.displayId:null}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._clusters.get(e);if(!t)return[];var r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}},{key:"getDisplayIdForReferenceId",value:function(e){var t,r=(0,g.Z)(this._clusters.values());try{for(r.s();!(t=r.n()).done;){var n=t.value;if((null==n?void 0:n.referenceId)===e)return n.displayId}}catch(i){r.e(i)}finally{r.f()}return null}},{key:"getAggregateValueRanges",value:function(){return this._aggregateValueRanges}},{key:"forEach",value:function(e){var t,r=(0,g.Z)(this._clusters);try{for(r.s();!(t=r.n()).done;){var n=(0,D.Z)(t.value,2),i=n[0],s=n[1];s&&e(s,i)}}catch(a){r.e(a)}finally{r.f()}}},{key:"size",value:function(){var e=0;return this.forEach((function(t){return e++})),e}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrated(),n=e.getYHydrated(),i=this._geohashBuf[2*t],s=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,i,s,this._geohashLevel))}},{key:"_update",value:function(e,t){var r=e.getDisplayId(),n=this._bitsets.inserted,i=t.isVisible(r);if(i!==n.has(r))if(i){var s=e.getXHydrated(),a=e.getYHydrated();if(this._setGeohash(r,s,a)){var o=this._geohashBuf[2*r],u=this._geohashBuf[2*r+1];this._tree.insertCursor(e,r,s,a,o,u,this._geohashLevel),n.set(r)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var i=bt(t/_t.sv.radius),s=i-360*Math.floor((i+180)/360);pt(n,e,bt(Math.PI/2-2*Math.atan(Math.exp(-r/_t.sv.radius))),s,12)}else{var a=(0,mt.iV)({x:t,y:r},this._spatialReference,De.Z.WGS84);if(!a)return!1;pt(n,e,a.y,a.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getClustersForTile",value:function(e,t,r,n,i){for(var s=this,a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=this._schema.params.clusterPixelBuffer,u=2*r,c=this._getGeohashLevel(t.key.level),l=Math.ceil(Math.pow(2,t.key.level)*it.I_/u),h=Math.ceil(o/u)+0,d=Math.ceil(it.I_/u),f=t.key,v=f.row,p=f.col,y=p*it.I_,g=v*it.I_,k=Math.floor(y/u)-h,x=Math.floor(g/u)-h,I=k+d+2*h,w=x+d+2*h,S=t.tileInfoView.getLODInfoAt(t.key.level),Z=k;Z<=I;Z++)for(var C=function(r){var o=Z;S.wrap&&(o=Z<0?Z+l:Z%l);var u=S.wrap&&Z<0,h=S.wrap&&Z%l!==Z,d=s._lookupCluster(n,S,t.key.level,o,r,c);if((0,m.pC)(d)){var f=(0,m.yw)(i,(function(e){return u?e.left:h?e.right:e.tile}));if(a&&(0,m.Wi)(f))return"continue";if(!d.count)return"continue";if((0,m.pC)(f)&&a){var v=d.geometry.clone(),p=d.attributes;v.coords[0]=(0,b.Jd)(f,v.coords[0]),v.coords[1]=(0,b.IN)(f,v.coords[1]),1===d.count&&(0,m.pC)(d.referenceId)&&(p=(0,_.Z)((0,_.Z)({},d.attributes),{},{referenceId:d.referenceId}));var y=new q.u_(v,p);y.displayId=d.displayId,e.push(y)}}},F=x;F<=w;F++)C(F)}},{key:"_getGeohashLevel",value:function(e){return Math.min(Math.ceil(e/2+2),12)}},{key:"_setGeohashLevel",value:function(e){var t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,this._rebuildTree(),void this._bitsets.geohash.clear()}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=(0,v.C5)(t);if(!n)return{tile:r,left:null,right:null};var i=(0,D.Z)(n.valid,2),s=i[0],a=i[1];return{tile:r,left:(0,_.Z)((0,_.Z)({},r),{},{translate:[a,e.bounds[3]]}),right:(0,_.Z)((0,_.Z)({},r),{},{translate:[s-a+e.bounds[0],e.bounds[3]]})}}},{key:"_getClusterId",value:function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}},{key:"_markForDeletion",value:function(e,t,r){var n=this._getClusterId(e,t,r);this._clusters.delete(n)}},{key:"_getClusterBounds",value:function(e,t,r){var n=this._schema.params.clusterRadius,i=2*n,s=r%2?t*i:t*i-n,a=r*i,o=s+i,u=a-i,c=Math.pow(2,e.level)*it.I_;e.wrap&&s<0&&(s=0),e.wrap&&o>c&&(o=c);var l=s/it.I_,h=a/it.I_,d=o/it.I_,f=u/it.I_;return[e.getXForColumn(l),e.getYForRow(h),e.getXForColumn(d),e.getYForRow(f)]}},{key:"_lookupCluster",value:function(e,t,r,n,i,s){var a=this._getClusterId(r,n,i),o=this._clusters.get(a),u=this._getClusterBounds(t,n,i),c=(0,D.Z)(u,4),l=c[0],h=c[1],d=c[2],f=c[3],v={x:l,y:h},p={x:d,y:f},y=0,g=0,k=0,x=0;if(this._spatialReference.isWebMercator){var b=bt(v.x/_t.sv.radius);y=b-360*Math.floor((b+180)/360),g=bt(Math.PI/2-2*Math.atan(Math.exp(-v.y/_t.sv.radius)));var I=bt(p.x/_t.sv.radius);k=I-360*Math.floor((I+180)/360),x=bt(Math.PI/2-2*Math.atan(Math.exp(-p.y/_t.sv.radius)))}else{var w=(0,mt.iV)(v,this._spatialReference,De.Z.WGS84),S=(0,mt.iV)(p,this._spatialReference,De.Z.WGS84);if(!w||!S)return null;y=w.x,g=w.y,k=S.x,x=S.y}var Z={geohashX:0,geohashY:0},C={geohashX:0,geohashY:0};vt(Z,g,y,s),vt(C,x,k,s);var F=Z.geohashX,T=Z.geohashY,A=C.geohashX,E=C.geohashY,M={xLL:F,yLL:T,xTR:A,yTR:E,level:s},O=this._tree.getRegionStatistics(F,T,A,E,s),R=O.count,z=O.xTotal,L=O.yTotal,q=O.referenceId,N=R?z/R:0,B=R?L/R:0;if(0===R)return this._clusters.set(a,null),null;var U=(0,_.Z)({cluster_count:R},O.attributes),P=(0,m.pC)(o)?o.update(N,B,r,U,M,q):xt.create(e,a,N,B,r,U,M,q);return 0===R&&(P.geometry.coords[0]=(l+d)/2,P.geometry.coords[1]=(h+f)/2),this._clusters.set(a,P),this._updateAggregateValueRangeForCluster(P,P.tileLevel),P}},{key:"_updateAggregateValueRangeForCluster",value:function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},n=r.minValue,i=r.maxValue;r.minValue=Math.min(n,e.count),r.maxValue=Math.max(i,e.count),this._aggregateValueRanges[t]=r,n===r.minValue&&i===r.maxValue||(this._aggregateValueRangesChanged=!0)}},{key:"_markTileClustersForDeletion",value:function(e,t){for(var r=2*t,n=Math.ceil(it.I_/r),i=e.key,s=i.row,a=i.col*it.I_,o=s*it.I_,u=Math.floor(a/r),c=Math.floor(o/r),l=u;l<u+n;l++)for(var h=c;h<c+n;h++)this._markForDeletion(e.key.level,l,h)}}]),r}(kt.J),wt=function(){function e(){(0,i.Z)(this,e),this._freeIds=[],this._idCounter=1}return(0,s.Z)(e,[{key:"createId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(0,st.QS)(this._getFreeId(),e)}},{key:"releaseId",value:function(e){this._freeIds.push(e)}},{key:"_getFreeId",value:function(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}]),e}(),St=r(44333);function Zt(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}var Ct=function(){function e(){(0,i.Z)(this,e),this._numerics=[],this._strings=[],this._idGenerator=new wt,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}return(0,s.Z)(e,[{key:"createBitset",value:function(){var e=this._bitsets.length;return this._bitsets.push(St.p.create(this._allocatedSize,st._I)),e+1}},{key:"getBitset",value:function(e){return this._bitsets[e-1]}},{key:"_expand",value:function(){this._allocatedSize<<=1;var e,t=(0,g.Z)(this._bitsets);try{for(t.s();!(e=t.n()).done;){e.value.resize(this._allocatedSize)}}catch(r){t.e(r)}finally{t.f()}}},{key:"_ensureNumeric",value:function(e,t){this._numerics[e]||(this._numerics[e]=[]),Zt(this._numerics[e],t,0)}},{key:"_ensureInstanceId",value:function(e){Zt(this._instanceIds,e,0)}},{key:"_ensureString",value:function(e,t){this._strings[e]||(this._strings[e]=[]),Zt(this._strings[e],t,null)}},{key:"createDisplayId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),(0,st.QS)(t,e)}},{key:"releaseDisplayId",value:function(e){var t,r=(0,g.Z)(this._bitsets);try{for(r.s();!(t=r.n()).done;){t.value.unset(e)}}catch(n){r.e(n)}finally{r.f()}return this._idGenerator.releaseId(e&st._I)}},{key:"getComputedNumeric",value:function(e,t){return this.getComputedNumericAtIndex(e&st._I,0)}},{key:"setComputedNumeric",value:function(e,t,r){return this.setComputedNumericAtIndex(e&st._I,r,0)}},{key:"getComputedString",value:function(e,t){return this.getComputedStringAtIndex(e&st._I,0)}},{key:"setComputedString",value:function(e,t,r){return this.setComputedStringAtIndex(e&st._I,0,r)}},{key:"getComputedNumericAtIndex",value:function(e,t){var r=e&st._I;return this._ensureNumeric(t,r),this._numerics[t][r]}},{key:"setComputedNumericAtIndex",value:function(e,t,r){var n=e&st._I;this._ensureNumeric(t,n),this._numerics[t][n]=r}},{key:"getInstanceId",value:function(e){var t=e&st._I;return this._ensureInstanceId(t),this._instanceIds[t]}},{key:"setInstanceId",value:function(e,t){var r=e&st._I;this._ensureInstanceId(r),this._instanceIds[r]=t}},{key:"getComputedStringAtIndex",value:function(e,t){var r=e&st._I;return this._ensureString(t,r),this._strings[t][r]}},{key:"setComputedStringAtIndex",value:function(e,t,r){var n=e&st._I;this._ensureString(t,n),this._strings[t][n]=r}},{key:"getXMin",value:function(e){return this._bounds[4*(e&st._I)]}},{key:"getYMin",value:function(e){return this._bounds[4*(e&st._I)+1]}},{key:"getXMax",value:function(e){return this._bounds[4*(e&st._I)+2]}},{key:"getYMax",value:function(e){return this._bounds[4*(e&st._I)+3]}},{key:"setBounds",value:function(e,t){var r=t.readHydratedGeometry();if(!r||!r.coords.length)return!1;var n=1/0,i=1/0,s=-1/0,a=-1/0;r.forEachVertex((function(e,t){n=Math.min(n,e),i=Math.min(i,t),s=Math.max(s,e),a=Math.max(a,t)}));var o=e&st._I;return Zt(this._bounds,4*o+4,0),this._bounds[4*o]=n,this._bounds[4*o+1]=i,this._bounds[4*o+2]=s,this._bounds[4*o+3]=a,!0}}]),e}();function Ft(e){if(!(0,k.D_)(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}function Tt(e){return"feature"===e.type&&"snapshot"===e.mode}var At=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,i.Z)(this,r),(e=t.apply(this,arguments))._storage=new Ct,e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e._didEdit=!1,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,e}return(0,s.Z)(r,[{key:"initialize",value:function(){var e=this;this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new be.e({concurrency:"geoevent"===this._source.type?1:4,process:function(t,r){return e._onTileMessage(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(function(t){return!t&&e.onIdle()}))]),this._checkUpdating=setInterval((function(){return e.notifyChange("updating")}),300)}},{key:"startup",value:function(){var e=(0,n.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._initAttributeStore();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initSource",value:function(){var e=this,t=this.tileStore.tileScheme;this._source=nt(this.service,this.spatialReference,t,(function(t,r){return e._invalidated=!0,e._patchTile(t,r)}),(function(){return e._updateQueue.length<50}),this.featureStore),this._proxyEvents()}},{key:"_proxyEvents",value:function(){var e=this;if("geoevent"===this._source.type){var t=this._source.events;this.handles.add([t.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(Ft)})),t.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(Ft)})),t.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(Ft)})),t.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:(0,_.Z)({},t)}).catch(Ft)}))])}}},{key:"_initAttributeStore",value:function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new ft({type:"remote",initialize:function(t,r){return(0,k.R8)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r}).catch(Ft))},update:function(t,r){return(0,k.R8)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r}).catch(Ft))},render:function(t){return(0,k.R8)(e.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(Ft))}},this.config)}},{key:"_initStores",value:function(){var e=this,t="snapshot"===this.service.type?"snapshot":"on-demand",r={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new S.p(r,this._storage,t),this.aggregateStore=new It(r,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(Ft)})))}},{key:"_initQueryEngine",value:function(){var e,t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new I.Z({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:function(e){return t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((function(e){return t.getObjectId(e)}))}},timeInfo:this.service.timeInfo})}},{key:"destroy",value:function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();var e,t=(0,g.Z)(this.tileStore.tiles);try{for(t.s();!(e=t.n()).done;){var r=e.value;this._source.unsubscribe(r)}}catch(n){t.e(n)}finally{t.f()}clearInterval(this._checkUpdating)}},{key:"fieldsIndex",get:function(){return new w.Z(this.service.fields)}},{key:"hasAggregates",get:function(){return!!this.config.schema.targets.aggregate}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}},{key:"isUpdating",value:function(){return this._source.updating||!!this._updateQueue.length}},{key:"enableEvent",value:function(e){this._source.enableEvent(e.name,e.value)}},{key:"pause",value:function(){this._updateQueue.pause(),this._updateQueue.clear()}},{key:"pauseStream",value:function(){"geoevent"===this._source.type&&this._source.pauseStream()}},{key:"resumeStream",value:function(){"geoevent"===this._source.type&&this._source.resumeStream()}},{key:"update",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._set("config",r),this._schema=r.schema,this._initQueryEngine(),e.next=5,Promise.all([this._source.update(t,r.schema.source),this.featureStore.updateSchema(t,r.schema.targets.feature),this.attributeStore.update(t,r),this.attributeStore.updateFilters(t,this)]);case 5:return e.next=7,this.aggregateStore.updateSchema(t,r.schema.targets.aggregate);case 7:(0,h.Z)("esri-2d-update-debug")&&t.describe();case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.mesh&&this.clearTiles(),this._updateQueue.resume(),e.next=4,this._source.applyUpdate(t);case 4:return this.notifyChange("updating"),e.next=7,(0,x.N1)((function(){return!r.updating}));case 7:if(e.t0=this.hasAggregates,!e.t0){e.next=13;break}return e.next=11,(0,k.e4)(10);case 11:return e.next=13,(0,x.N1)((function(){return!r.updating}));case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onEdits",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.edits,(0,h.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",r),this._didEdit=!0,e.prev=2,n=r.removed.map((function(e){return e.objectId&&-1!==e.objectId?e.objectId:s._lookupObjectIdByGlobalId(e.globalId)})),i=r.addOrModified.map((function(e){return e.objectId})),this.featureStore.invalidate(),e.next=7,this._source.edit(i,n);case 7:return this.clearTiles(),this.notifyChange("updating"),this.aggregateStore.clear(),e.next=12,this._source.resend();case 12:return e.next=14,(0,x.N1)((function(){return!s.updating}));case 14:e.next=18;break;case 16:e.prev=16,e.t0=e.catch(2);case 18:case"end":return e.stop()}}),e,this,[[2,16]])})));return function(t){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return r=_e.empty(),e.abrupt("return",(r.storage.filters=!0,this.applyUpdate(r)));case 3:return this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(),this._cleanupNeeded=!0,this.notifyChange("updating"),e.next=10,(0,x.N1)((function(){return!n.updating}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"clearTiles",value:function(){var e,t=(0,g.Z)(this.tileStore.tiles);try{for(t.s();!(e=t.n()).done;){var r=e.value;this.processor.onTileClear(r)}}catch(n){t.e(n)}finally{t.f()}}},{key:"onTileUpdate",value:function(e){this.aggregateStore.onTileUpdate(e);var t,r=(0,g.Z)(e.added);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._source.subscribe(n),this._level=n.level}}catch(o){r.e(o)}finally{r.f()}var i,s=(0,g.Z)(e.removed);try{for(s.s();!(i=s.n()).done;){var a=i.value;this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id))}}catch(o){s.e(o)}finally{s.f()}this.notifyChange("updating")}},{key:"onIdle",value:function(){this._invalidated&&((this.hasAggregates||"heatmap"===this.processor.type)&&this._repushCurrentLevelTiles(),this._invalidated=!1),this._markAndSweep()}},{key:"querySummaryStatistics",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForSummaryStatistics(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForUniqueValues(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForClassBreaks(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForHistogram(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(e){return this.queryEngine.executeQueryForExtent(e)}},{key:"queryFeatures",value:function(e){return this.queryEngine.executeQuery(e)}},{key:"queryVisibleFeatures",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryEngine.executeQuery(t);case 2:return r=e.sent,n=r.objectIdFieldName,e.abrupt("return",(r.features=r.features.filter((function(e){var t=e.attributes[n],r=i.getDisplayId(t);return i.attributeStore.isVisible(r)})),r));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryFeatureCount",value:function(e){return this.queryEngine.executeQueryForCount(e)}},{key:"queryLatestObservations",value:function(e){return this.queryEngine.executeQueryForLatestObservations(e)}},{key:"queryObjectIds",value:function(e){return this.queryEngine.executeQueryForIds(e)}},{key:"queryStatistics",value:function(){var e=(0,n.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.featureStore.storeStatistics);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(e){return this.featureStore.lookupObjectId(e,this._storage)}},{key:"getDisplayId",value:function(e){if(this._schema.targets.aggregate){var t=this.aggregateStore.getDisplayId(e);if((0,m.Wi)(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)}},{key:"getFeatures",value:function(e){var t,r=[],n=[],i=(0,g.Z)(e);try{for(i.s();!(t=i.n()).done;){var s=t.value,a=this.hasAggregates?this.getAggregate(s):null;if((0,m.pC)(a))if((0,m.pC)(a.referenceId)){var o=this.getFeature(a.referenceId);(0,m.pC)(o)&&r.push(o)}else n.push(a);else{var u=this.getFeature(s);(0,m.pC)(u)&&r.push(u)}}}catch(c){i.e(c)}finally{i.f()}return{features:r,aggregates:n}}},{key:"getFeature",value:function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if((0,m.Wi)(t))return null;var r=t.readHydratedGeometry(),n=(0,b.di)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:n}}},{key:"getAggregate",value:function(e){return this.aggregateStore.getAggregate(e)}},{key:"getAggregates",value:function(){return this.aggregateStore.getAggregates()}},{key:"setHighlight",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n=this;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return n.getDisplayId(e)})),e.abrupt("return",this.attributeStore.setHighlight(t,r));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_lookupObjectIdByGlobalId",value:function(e){var t=this.service.globalIdField;if((0,m.Wi)(t))throw new Error("Expected globalIdField to be defined");var r=null;if(this.featureStore.forEach((function(n){e===n.readAttribute(t)&&(r=n.getObjectId())})),(0,m.Wi)(r))throw new Error("Expected to find a feature with globalId ".concat(e));return r}},{key:"_repushCurrentLevelTiles",value:function(){var e,t=this,r=this.tileStore.tiles.filter((function(e){return e.level===t._level})),n=(0,g.Z)(r);try{for(n.s();!(e=n.n()).done;){var i=e.value;this._patchTile({type:"append",id:i.key.id,addOrUpdate:B.fromOptimizedFeatures([],this.service),remove:[],end:!0,status:_e.empty()})}}catch(s){n.e(s)}finally{n.f()}}},{key:"_maybeForceCleanup",value:function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}},{key:"_patchTile",value:function(e,t){var r=this,n=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){r.notifyChange("updating")}));return this.notifyChange("updating"),n}},{key:"_onTileMessage",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o,c,l,h,d;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,k.k_)(r),n=this.tileStore.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:if(!t.clear){e.next=6;break}return e.abrupt("return",this.processor.onTileClear(n));case 6:i=t.status,this._cleanupNeeded=!0,s=[],a=(0,g.Z)(t.remove);try{for(a.s();!(o=a.n()).done;)c=o.value,(l=this.featureStore.lookupDisplayId(c))&&s.push(l)}catch(u){a.e(u)}finally{a.f()}if(t.remove=s,e.prev=12,!(0,m.Wi)(t.addOrUpdate)){e.next=15;break}return e.abrupt("return",void this.processor.onTileMessage(n,(0,_.Z)((0,_.Z)({},t),{},{addOrUpdate:null}),this.hasAggregates,r).catch(k.H9));case 15:if(t.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(t.addOrUpdate.instance)&&i.targets.feature||(i.targets.feature=!0,this.featureStore.onTileData(n,t)),i.storage.data&&i.storage.filters){e.next=24;break}if(i.storage.data=!0,i.storage.filters=!0,this.attributeStore.onTileData(n,t),"geoevent"!==this._source.type&&!this._didEdit){e.next=23;break}return e.next=20,this.attributeStore.sendUpdates();case 20:(0,k.k_)(r),e.next=24;break;case 23:this.attributeStore.sendUpdates();case 24:if(!this.hasAggregates||i.targets.aggregate){e.next=35;break}if(i.targets.aggregate=!0,h=Tt(this._source)&&this._source.loading,d=!Tt(this._source)||h||t.end,this.aggregateStore.onTileData(n,t,this._storage,this.attributeStore,d),d){e.next=29;break}return e.abrupt("return");case 29:if(e.t0=i.mesh,e.t0){e.next=35;break}return this.attributeStore.onTileData(n,t),e.next=34,this.attributeStore.sendUpdates();case 34:this.processor.onTileClear(n);case 35:if(e.t1=i.mesh,e.t1){e.next=41;break}return i.mesh=!0,e.next=40,this.processor.onTileMessage(n,t,this.hasAggregates,r);case 40:(0,k.k_)(r);case 41:this._maybeForceCleanup(),e.next=47;break;case 44:e.prev=44,e.t2=e.catch(12),(0,k.H9)(e.t2);case 47:case"end":return e.stop()}}),e,this,[[12,44]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_mark",value:function(e,t,r){var n=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(n),r.set(e))}},{key:"_markAndSweep",value:function(){var e=this;if(this._lastCleanup=performance.now(),!("feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();var n,i=(0,g.Z)(this.tileStore.tiles);try{for(i.s();!(n=i.n()).done;){var s,a=n.value,o=(0,g.Z)(this._source.readers(a.id));try{for(o.s();!(s=o.n()).done;)for(var u=s.value.getCursor();u.next();){var c=u.getDisplayId();if(!c){var l=u.getObjectId();c=this.featureStore.lookupDisplayId(l)}this._mark(c,r,t)}}catch(h){o.e(h)}finally{o.f()}}}catch(h){i.e(h)}finally{i.f()}"symbol"===this.processor.type&&this.processor.forEachBufferId((function(n){e._mark(n,r,t)})),this._updateQueue.forEach((function(n){var i,s=(0,g.Z)(n.remove);try{for(s.s();!(i=s.n()).done;){var a=i.value,o=e.featureStore.lookupDisplayId(a);e._mark(o,r,t)}}catch(h){s.e(h)}finally{s.f()}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(r)}}}]),r}(l.r);(0,c._)([(0,d.Cb)({constructOnly:!0})],At.prototype,"tileStore",void 0),(0,c._)([(0,d.Cb)()],At.prototype,"config",void 0),(0,c._)([(0,d.Cb)({readOnly:!0})],At.prototype,"fieldsIndex",null),(0,c._)([(0,d.Cb)()],At.prototype,"processor",void 0),(0,c._)([(0,d.Cb)({constructOnly:!0})],At.prototype,"remoteClient",void 0),(0,c._)([(0,d.Cb)({constructOnly:!0})],At.prototype,"service",void 0),(0,c._)([(0,d.Cb)()],At.prototype,"spatialReference",null),(0,c._)([(0,d.Cb)()],At.prototype,"updating",null);var Et=At=(0,c._)([(0,f.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],At),Mt=r(67906),Ot=r(48790),Rt=r(73828),zt={added:[],removed:[]},Lt=new Set,qt=new Rt.Z(0,0,0,0),Nt=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this))._tiles=new Map,n._index=(0,Te.r)(9,(0,h.Z)("esri-csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),n.tiles=[],n.tileScheme=e,n}return(0,s.Z)(r,[{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}},{key:"has",value:function(e){return this._tiles.has(e)}},{key:"get",value:function(e){return this._tiles.get(e)}},{key:"boundsIntersections",value:function(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}},{key:"updateTiles",value:function(e){var t,r=this,n={added:[],removed:[]},i=(0,g.Z)(e.added);try{for(i.s();!(t=i.n()).done;){var s=t.value;if(!this.has(s)){var a=new Mt.n(this.tileScheme,s);this._tiles.set(s,a),this._index.insert(a),n.added.push(a)}}}catch(h){i.e(h)}finally{i.f()}var o,u=(0,g.Z)(e.removed);try{for(u.s();!(o=u.n()).done;){var c=o.value;if(this.has(c)){var l=this.get(c);this._tiles.delete(c),this._index.remove(l),n.removed.push(l)}}}catch(h){u.e(h)}finally{u.f()}this.tiles.length=0,this._tiles.forEach((function(e){return r.tiles.push(e)})),(n.added.length||n.removed.length)&&this.emit("update",n)}},{key:"setViewState",value:function(e){var t=this.tileScheme.getTileCoverage(e,0);if(t){var r=t.spans,n=t.lodInfo,i=n.level;if(r.length>0){var s,a=(0,g.Z)(r);try{for(a.s();!(s=a.n()).done;)for(var o=s.value,u=o.row,c=o.colFrom,l=o.colTo,h=c;h<=l;h++){var d=qt.set(i,u,n.normalizeCol(h),n.getWorldForColumn(h)).id;if(Lt.add(d),!this.has(d)){var f=new Mt.n(this.tileScheme,d);this._tiles.set(d,f),this._index.insert(f),this.tiles.push(f),zt.added.push(f)}}}catch(y){a.e(y)}finally{a.f()}}for(var v=this.tiles.length-1;v>=0;v--){var p=this.tiles[v];Lt.has(p.id)||(this._tiles.delete(p.id),this.tiles.splice(v,1),this._index.remove(p),zt.removed.push(p))}(zt.added.length||zt.removed.length)&&this.emit("update",zt),Ot.Z.pool.release(t),Lt.clear(),zt.added.length=0,zt.removed.length=0}}}]),r}(ve.Z),Bt=r(37995),Dt=new Set;function Ut(){return Dt}var Pt=function(e){(0,a.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,i.Z)(this,r),(e=t.apply(this,arguments)).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e._paused=!1,e._pendingTileUpdates=[],e}return(0,s.Z)(r,[{key:"initialize",value:function(){var e=this;this.handles.add(this.watch("updating",(function(t){e.remoteClient.invoke("setUpdating",t).catch((function(e){}))})))}},{key:"destroy",value:function(){var e,t;this.stop(),null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}},{key:"updating",get:function(){return!this.controller||this.controller.updating}},{key:"stop",value:function(){var e,t,r;this._paused=!0,Array.isArray(null==(e=this.service)?void 0:e.source)&&(this.service.source.forEach((function(e){return e.close()})),this.service.source.length=0),null==(t=this.tileStore)||t.updateTiles({added:[],removed:this.tileStore.tiles.map((function(e){return e.id}))}),null==(r=this.tileStore)||r.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}},{key:"startup",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s,a,o,c,l;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.service,n=t.config,i=t.tileInfo,s=t.tiles,this._paused=!0,Array.isArray(null==(a=this.service)?void 0:a.source)&&(this.service.source.forEach((function(e){return e.close()})),this.service.source.length=0),this.service=r,this.tileStore&&(0,v.fS)(this.tileStore.tileScheme.spatialReference,i.spatialReference)||(l=new Bt.Z(p.Z.fromJSON(i)),s.added.length=s.removed.length=0,null==(o=this.tileStore)||o.updateTiles({added:[],removed:this.tileStore.tiles.map((function(e){return e.id}))}),null==(c=this.tileStore)||c.destroy(),this.tileStore=new Nt(l),this._pendingTileUpdates.length=0),e.next=4,this._createProcessorAndController(n);case 4:return e.next=6,this.update({config:n},!0);case 6:this.tileStore.clear(),this.tileStore.updateTiles(s),this._paused=!1;case 9:if(!this._pendingTileUpdates.length){e.next=13;break}this.tileStore.updateTiles(this._pendingTileUpdates.pop());case 11:e.next=9;break;case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._paused?this._pendingTileUpdates.push(t):this.tileStore.updateTiles(t);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r,n,i,s=arguments;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.config,n=s.length>1&&void 0!==s[1]&&s[1],i=_e.empty(),n||this.controller.pause(),e.next=6,Promise.all([this.processor.update(i,r),this.controller.update(i,r)]);case 6:return e.abrupt("return",i.toJSON());case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.controller.applyUpdate(_e.create(t)));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createProcessorAndController",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this._handleControllerConfig(t),this._handleProcessorConfig(t)]);case 2:this.controller.processor=this.processor;case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleControllerConfig",value:function(){var e=(0,n.Z)(u.mark((function e(t){var r;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._createController(this.service,t);case 2:return r=e.sent,e.next=5,r.startup();case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleProcessorConfig",value:function(){var e=(0,n.Z)(u.mark((function e(t){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createProcessor(this.service,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createController",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.controller&&this.controller.destroy(),n=this.tileStore,i=this.remoteClient,s=new Et({service:t,config:r,tileStore:n,remoteClient:i}),e.abrupt("return",(this.controller=s,s));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createProcessor",value:function(){var e=(0,n.Z)(u.mark((function e(t,r){var n,i,s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.schema.processors[0].type,e.next=3,y(n);case 3:return i=e.sent.default,s=this.remoteClient,a=this.tileStore,o=new i({service:t,config:r,tileStore:a,remoteClient:s}),e.abrupt("return",(this.processor&&this.processor.destroy(),this.processor=o,o));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(l.r);(0,c._)([(0,d.Cb)()],Pt.prototype,"controller",void 0),(0,c._)([(0,d.Cb)()],Pt.prototype,"processor",void 0),(0,c._)([(0,d.Cb)()],Pt.prototype,"updating",null),(0,c._)([(0,d.Cb)()],Pt.prototype,"viewState",void 0);var jt=Pt=(0,c._)([(0,f.j)("esri.views.2d.layers.features.Pipeline")],Pt)},24170:function(e,t,r){r.d(t,{J:function(){return p}});var n=r(1413),i=r(37762),s=r(15861),a=r(15671),o=r(43144),u=r(87757),c=r(93169),l=r(92026),h=r(48732),d=r(819),f=r(32718);var v=r.e(6553).then(r.bind(r,16553)),p=function(){function e(t,r){(0,a.Z)(this,e),this._canCacheExpressionValue=!1,this._sourceInfo=t,this._bitsets={computed:r.getBitset(r.createBitset())}}return(0,o.Z)(e,[{key:"invalidate",value:function(){this._bitsets.computed.clear()}},{key:"updateSchema",value:function(){var e=(0,s.Z)(u.mark((function e(t,r){var n,i,s,a,o,d;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,h.Hg)(this._schema,r),this._schema=r,r&&!(0,l.Wi)(n)&&(0,h.uD)(n,"attributes")){e.next=3;break}return e.abrupt("return");case 3:(0,c.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",n),this._bitsets.computed.clear(),t.targets[r.name]=!0,i=r.attributes,s=[],a=[],e.t0=u.keys(i);case 6:if((e.t1=e.t0()).done){e.next=20;break}o=e.t1.value,d=i[o],e.t2=d.type,e.next="field"===e.t2?12:"expression"===e.t2?13:"label-expression"===e.t2?15:"statistic"===e.t2?17:18;break;case 12:return e.abrupt("break",18);case 13:return s.push(this._createArcadeComputedField(d)),e.abrupt("break",18);case 15:return s.push(this._createLabelArcadeComputedField(d)),e.abrupt("break",18);case 17:a.push(d);case 18:e.next=6;break;case 20:return e.next=22,Promise.all(s);case 22:this._computedFields=e.sent,this._canCacheExpressionValue=!this._computedFields.some((function(e){return"expression"===e.type&&e.expression.referencesScale()})),this._statisticFields=a;case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setComputedAttributes",value:function(e,t,r,n){var s=this._bitsets.computed;if(!this._canCacheExpressionValue||!s.has(r)){s.set(r);var a,o=(0,i.Z)(this._computedFields);try{for(o.s();!(a=o.n()).done;){var u=a.value,c=this._evaluateField(t,u,n);switch(u.resultType){case"numeric":e.setComputedNumericAtIndex(r,u.fieldIndex,c);break;case"string":e.setComputedStringAtIndex(r,u.fieldIndex,c)}}}catch(l){o.e(l)}finally{o.f()}}}},{key:"_createArcadeComputedField",value:function(){var e=(0,s.Z)(u.mark((function e(t){var r,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,i=this._sourceInfo.fieldsIndex,e.t0=n.Z,e.t1=(0,n.Z)({},t),e.t2={},e.next=6,(0,d.Yi)(t.valueExpression,r,i);case 6:return e.t3=e.sent,e.t4={expression:e.t3},e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t4));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelArcadeComputedField",value:function(){var e=(0,s.Z)(u.mark((function e(t){var r,i,s,a,o;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,i=this._sourceInfo.fieldsIndex,e.next=4,v;case 4:return s=e.sent,a=s.createLabelFunction,e.next=8,a(t.label,i,r);case 8:return o=e.sent,e.abrupt("return",(0,n.Z)((0,n.Z)({},t),{},{builder:o}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_evaluateField",value:function(t,r,i){switch(r.type){case"label-expression":var s=t.readArcadeFeature();return r.builder.evaluate(s)||"";case"expression":return function(t,r,i){t.referencesGeometry();var s=r.readArcadeFeature();try{return t.evaluate((0,n.Z)((0,n.Z)({},i),{},{$feature:s}))}catch(e){return f.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}(r.expression,t,{$view:{scale:i}})}}}]),e}()},92010:function(e,t,r){r.d(t,{s:function(){return T}});var n,i,s,a=r(37762),o=r(15671),u=r(43144),c=r(87757),l=(r(59486),r(93169)),h=r(92026),d=r(85403),f=r(83406),v=r(80457),p=r(44333),y=r(77981),g=0,_=null!=(n=(0,l.Z)("featurelayer-simplify-thresholds"))?n:[.5,.5,.5,.5],m=_[0],k=_[1],x=_[2],b=_[3],I=null!=(i=(0,l.Z)("featurelayer-simplify-payload-size-factors"))?i:[1,2,4],w=I[0],S=I[1],Z=I[2],C=null!=(s=(0,l.Z)("featurelayer-simplify-mobile-factor"))?s:2,F=(0,l.Z)("esri-mobile"),T=function(){function e(t,r){(0,o.Z)(this,e),this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=t,this._layerSchema=r}return(0,u.Z)(e,[{key:"isEmpty",get:function(){return(0,h.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}},{key:"level",set:function(e){this._level=e}},{key:"getAreaSimplificationThreshold",value:function(e,t){var r=1,n=F?C:1;t>4e6?r=Z*n:t>1e6?r=S*n:t>5e5?r=w*n:t>1e5&&(r=n);var i=0;e>4e3?i=b*r:e>2e3?i=x*r:e>100?i=k:e>15&&(i=m);var s=8;return this._level<4?s=1:this._level<5?s=2:this._level<6&&(s=4),i*s}},{key:"setArcadeSpatialReference",value:function(e){this._arcadeSpatialReference=e}},{key:"attachStorage",value:function(e){this._storage=e}},{key:"getQuantizationTransform",value:function(){throw new Error("Unable to find transform for featureSet")}},{key:"getStorage",value:function(){return this._storage}},{key:"getComputedNumeric",value:function(e){return this.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}},{key:"transform",value:function(e,t,r,n){var i=this.copy();return i._tx+=e,i._ty+=t,i._sx*=r,i._sy*=n,i}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._readAttribute(e,t);if(void 0!==r)return r;var n,i=(0,a.Z)(this._joined);try{for(i.s();!(n=i.n()).done;){var s=n.value;s.setIndex(this.getIndex());var o=s._readAttribute(e,t);if(void 0!==o)return o}}catch(u){i.e(u)}finally{i.f()}}},{key:"readAttributes",value:function(){var e,t=this._readAttributes(),r=(0,a.Z)(this._joined);try{for(r.s();!(e=r.n()).done;){var n=e.value;n.setIndex(this.getIndex());for(var i=n._readAttributes(),s=0,o=Object.keys(i);s<o.length;s++){var u=o[s];t[u]=i[u]}}}catch(c){r.e(c)}finally{r.f()}return t}},{key:"joinAttributes",value:function(e){this._joined.push(e)}},{key:"readArcadeFeature",value:function(){return this}},{key:"geometry",value:function(){var e=this.readHydratedGeometry(),t=(0,f.di)(e,this.geometryType,this.hasZ,this.hasM),r=(0,y.im)(t);return r&&(r.spatialReference=this._arcadeSpatialReference),r}},{key:"field",value:function(e){if(this.hasField(e))return this.readAttribute(e,!0);var t,r=(0,a.Z)(this._joined);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.setIndex(this.getIndex()),n.hasField(e))return n._readAttribute(e,!0)}}catch(i){r.e(i)}finally{r.f()}throw new Error("Field ".concat(e," does not exist"))}},{key:"setField",value:function(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}},{key:"keys",value:function(){return this.getFieldNames()}},{key:"castToText",value:function(){return JSON.stringify(this.readLegacyFeature())}},{key:"gdbVersion",value:function(){return null}},{key:"fullSchema",value:function(){return this._layerSchema}},{key:"castAsJson",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return{attributes:this._readAttributes(),geometry:!0===(null==e?void 0:e.keepGeometryType)?this.geometry():this.geometry().toJSON()}}},{key:"castAsJsonAsync",value:function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return Promise.resolve(this.castAsJson(e))}},{key:"removeIds",value:function(e){if((0,h.Wi)(this._objectIdToIndex)){for(var t=new Map,r=this.getCursor();r.next();)t.set(r.getObjectId(),r.getIndex());this._objectIdToIndex=t}var n,i=this._objectIdToIndex,s=(0,a.Z)(e);try{for(s.s();!(n=s.n()).done;){var o=n.value;i.has(o)&&this.removeAtIndex(i.get(o))}}catch(u){s.e(u)}finally{s.f()}}},{key:"removeAtIndex",value:function(e){(0,h.Wi)(this._deleted)&&(this._deleted=p.p.create(this.getSize())),this._deleted.set(e)}},{key:"readGeometryForDisplay",value:function(){return this.readUnquantizedGeometry(!0)}},{key:"readLegacyGeometryForDisplay",value:function(){return this.readLegacyGeometry(!0)}},{key:"features",value:c.mark((function e(){var t;return c.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.getCursor();case 1:if(!t.next()){e.next=6;break}return e.next=4,t.readOptimizedFeature();case 4:e.next=1;break;case 6:case"end":return e.stop()}}),e,this)}))},{key:"_getExists",value:function(){return(0,h.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}},{key:"_computeCentroid",value:function(){if("esriGeometryPolygon"!==this.geometryType)return null;var e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;var t=(0,h.Pt)(this.getQuantizationTransform(),null);return(0,d.Y)(new v.Z,e,this.hasM,this.hasZ,t)}},{key:"copyInto",value:function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex}}],[{key:"createInstance",value:function(){return g=++g>65535?0:g}}]),e}()},5448:function(e,t,r){r.d(t,{t:function(){return u}});var n=r(15671),i=r(43144),s=r(60136),a=r(29388),o=r(92010),u=function(e){(0,s.Z)(r,e);var t=(0,a.Z)(r);function r(e,i){var s;return(0,n.Z)(this,r),(s=t.call(this,o.s.createInstance(),e.fullSchema()))._currentIndex=-1,s._reader=e,s._indices=i,s}return(0,i.Z)(r,[{key:"hasNext",get:function(){return this._currentIndex+1<this._indices.length}},{key:"getSize",value:function(){return this._indices.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"copy",value:function(){var e=new r(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e}},{key:"next",value:function(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}},{key:"_nextIndex",value:function(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}},{key:"setArcadeSpatialReference",value:function(e){this._reader.setArcadeSpatialReference(e)}},{key:"attachStorage",value:function(e){this._reader.attachStorage(e)}},{key:"geometryType",get:function(){return this._reader.geometryType}},{key:"hasFeatures",get:function(){return this._reader.hasFeatures}},{key:"exceededTransferLimit",get:function(){return this._reader.exceededTransferLimit}},{key:"hasZ",get:function(){return this._reader.hasZ}},{key:"hasM",get:function(){return this._reader.hasM}},{key:"getStorage",value:function(){return this._reader.getStorage()}},{key:"getComputedNumeric",value:function(e){return this._reader.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this._reader.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this._reader.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this._reader.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._reader.getComputedNumericAtIndex(e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._reader.setComputedNumericAtIndex(e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._reader.getComputedStringAtIndex(e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._reader.setComputedStringAtIndex(e,t)}},{key:"transform",value:function(e,t,r,n){var i=this.copy();return i._reader=this._reader.transform(e,t,r,n),i}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._reader.readAttribute(e,t)}},{key:"readAttributes",value:function(){return this._reader.readAttributes()}},{key:"joinAttributes",value:function(e){return this._reader.joinAttributes(e)}},{key:"readArcadeFeature",value:function(){return this._reader.readArcadeFeature()}},{key:"geometry",value:function(){return this._reader.geometry()}},{key:"field",value:function(e){return this.readAttribute(e,!0)}},{key:"hasField",value:function(e){return this._reader.hasField(e)}},{key:"setField",value:function(e,t){return this._reader.setField(e,t)}},{key:"keys",value:function(){return this._reader.keys()}},{key:"castToText",value:function(){return this._reader.castToText()}},{key:"getQuantizationTransform",value:function(){return this._reader.getQuantizationTransform()}},{key:"getFieldNames",value:function(){return this._reader.getFieldNames()}},{key:"getAttributeHash",value:function(){return this._reader.getAttributeHash()}},{key:"getObjectId",value:function(){return this._reader.getObjectId()}},{key:"getDisplayId",value:function(){return this._reader.getDisplayId()}},{key:"setDisplayId",value:function(e){return this._reader.setDisplayId(e)}},{key:"getGroupId",value:function(){return this._reader.getGroupId()}},{key:"setGroupId",value:function(e){return this._reader.setGroupId(e)}},{key:"getXHydrated",value:function(){return this._reader.getXHydrated()}},{key:"getYHydrated",value:function(){return this._reader.getYHydrated()}},{key:"getX",value:function(){return this._reader.getX()}},{key:"getY",value:function(){return this._reader.getY()}},{key:"setIndex",value:function(e){return this._reader.setIndex(e)}},{key:"getIndex",value:function(){return this._reader.getIndex()}},{key:"readLegacyFeature",value:function(){return this._reader.readLegacyFeature()}},{key:"readOptimizedFeature",value:function(){return this._reader.readOptimizedFeature()}},{key:"readLegacyPointGeometry",value:function(){return this._reader.readLegacyPointGeometry()}},{key:"readLegacyGeometry",value:function(){return this._reader.readLegacyGeometry()}},{key:"readLegacyCentroid",value:function(){return this._reader.readLegacyCentroid()}},{key:"readGeometryArea",value:function(){return this._reader.readGeometryArea()}},{key:"readUnquantizedGeometry",value:function(){return this._reader.readUnquantizedGeometry()}},{key:"readHydratedGeometry",value:function(){return this._reader.readHydratedGeometry()}},{key:"readGeometry",value:function(){return this._reader.readGeometry()}},{key:"readCentroid",value:function(){return this._reader.readCentroid()}},{key:"_readAttribute",value:function(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}},{key:"_readAttributes",value:function(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}],[{key:"from",value:function(e,t){return new r(e.copy(),t)}}]),r}(o.s)},44333:function(e,t,r){r.d(t,{p:function(){return s}});var n=r(15671),i=r(43144),s=function(){function e(t,r){(0,n.Z)(this,e),this._mask=0,this._buf=t,this._mask=r}return(0,i.Z)(e,[{key:"_getIndex",value:function(e){return Math.floor(e/32)}},{key:"has",value:function(e){var t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}},{key:"hasRange",value:function(e,t){for(var r=e,n=t;r%32&&r!==n;){if(this.has(r))return!0;r++}for(;n%32&&r!==n;){if(this.has(r))return!0;n--}if(r===n)return!1;for(var i=r/32;i!==n/32;i++)if(this._buf[i])return!0;return!1}},{key:"set",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]|=n}},{key:"setRange",value:function(e,t){for(var r=e,n=t;r%32&&r!==n;)this.set(r++);for(;n%32&&r!==n;)this.set(n--);if(r!==n)for(var i=r/32;i!==n/32;i++)this._buf[i]=4294967295}},{key:"unset",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]&=4294967295^n}},{key:"resize",value:function(e){var t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}},{key:"or",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}},{key:"and",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}},{key:"xor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}},{key:"ior",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}},{key:"iand",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}},{key:"ixor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}},{key:"any",value:function(){for(var e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}},{key:"copy",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}},{key:"clone",value:function(){return new e(this._buf.slice(),this._mask)}},{key:"clear",value:function(){for(var e=0;e<this._buf.length;e++)this._buf[e]=0}},{key:"forEachSet",value:function(e){for(var t=0;t<this._buf.length;t++){var r=this._buf[t],n=32*t;if(r)for(;r;)1&r&&e(n),r>>>=1,n++}}},{key:"countSet",value:function(){var e=0;return this.forEachSet((function(t){e++})),e}}],[{key:"fromBuffer",value:function(t,r){return new e(t,r)}},{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,n=new Uint32Array(Math.ceil(t/32));return new e(n,r)}}]),e}()},67906:function(e,t,r){r.d(t,{n:function(){return l}});var n=r(15671),i=r(43144),s=r(22213),a=r(53866),o=r(65156),u=r(94618),c=r(73828),l=function(){function e(t,r){(0,n.Z)(this,e),this.key=new c.Z(0,0,0,0),this.bounds=(0,o.Ue)(),this.objectIds=new Set,this.key.set(r);var i=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.scale=i.scale,this.level=i.level}return(0,i.Z)(e,[{key:"id",get:function(){return this.key.id}},{key:"extent",get:function(){return a.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}},{key:"transform",get:function(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}},{key:"createChildTiles",value:function(){for(var t=this.key.getChildKeys(),r=s.Z.acquire(),n=0;n<t.length;n++)r[n]=new e(this.tileInfoView,t[n]);return r}},{key:"getQuantizationParameters",value:function(){return u.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}]),e}()},48790:function(e,t,r){r.d(t,{Z:function(){return o}});var n=r(37762),i=r(15671),s=r(43144),a=r(13005),o=function(){function e(){(0,i.Z)(this,e),this.spans=[]}return(0,s.Z)(e,[{key:"acquire",value:function(e){this.lodInfo=e}},{key:"release",value:function(){this.lodInfo=null,this.spans.length=0}},{key:"forEach",value:function(e,t){var r=this.spans,i=this.lodInfo,s=i.level;if(0!==r.length){var a,o=(0,n.Z)(r);try{for(o.s();!(a=o.n()).done;)for(var u=a.value,c=u.row,l=u.colFrom,h=u.colTo,d=l;d<=h;d++)e.call(t,s,c,i.normalizeCol(d),i.getWorldForColumn(d))}catch(f){o.e(f)}finally{o.f()}}}}]),e}();o.pool=new a.Z(o)},37995:function(e,t,r){r.d(t,{Z:function(){return k}});var n=r(37762),i=r(70885),s=r(15671),a=r(43144),o=r(92975),u=r(92026),c=r(73828);function l(e,t){return[e,t]}function h(e,t,r){return e[0]=t,e[1]=r,e}function d(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e}var f=new c.Z("0/0/0/0"),v=function(){function e(t,r,n,i,a,o,u,c,l,h,d,f){(0,s.Z)(this,e),this.level=t,this.resolution=r,this.scale=n,this.origin=i,this.first=a,this.last=o,this.size=u,this.norm=c,this.worldStart=l,this.worldEnd=h,this.worldSize=d,this.wrap=f}return(0,a.Z)(e,[{key:"normalizeCol",value:function(e){if(!this.wrap)return e;var t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}},{key:"denormalizeCol",value:function(e,t){return this.wrap?this.worldSize[0]*t+e:e}},{key:"getWorldForColumn",value:function(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}},{key:"getFirstColumnForWorld",value:function(e){return e*this.worldSize[0]+this.first[0]}},{key:"getLastColumnForWorld",value:function(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}},{key:"getColumnForX",value:function(e){return(e-this.origin[0])/this.norm[0]}},{key:"getXForColumn",value:function(e){return this.origin[0]+e*this.norm[0]}},{key:"getRowForY",value:function(e){return(this.origin[1]-e)/this.norm[1]}},{key:"getYForRow",value:function(e){return this.origin[1]-e*this.norm[1]}},{key:"getTileBounds",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];f.set(t);var n=r?f.col:this.denormalizeCol(f.col,f.world),i=f.row;return d(e,this.getXForColumn(n),this.getYForRow(i+1),this.getXForColumn(n+1),this.getYForRow(i)),e}},{key:"getTileCoords",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];f.set(t);var n=r?f.col:this.denormalizeCol(f.col,f.world);return Array.isArray(e)?h(e,this.getXForColumn(n),this.getYForRow(f.row)):(e.x=this.getXForColumn(n),e.y=this.getYForRow(f.row)),e}}],[{key:"create",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=(0,o.C5)(t.spatialReference),s=r.origin||l(t.origin.x,t.origin.y),a=l(t.size[0]*r.resolution,t.size[1]*r.resolution),c=l(-1/0,-1/0),d=l(1/0,1/0),f=l(1/0,1/0);(0,u.pC)(n)&&(h(c,Math.max(0,Math.floor((n.xmin-s[0])/a[0])),Math.max(0,Math.floor((s[1]-n.ymax)/a[1]))),h(d,Math.max(0,Math.floor((n.xmax-s[0])/a[0])),Math.max(0,Math.floor((s[1]-n.ymin)/a[1]))),h(f,d[0]-c[0]+1,d[1]-c[1]+1));var v,p,y,g,_=r.cols,m=r.rows;return!n&&_&&m&&(h(c,_[0],m[0]),h(d,_[1],m[1]),h(f,_[1]-_[0]+1,m[1]-m[0]+1)),t.isWrappable?(v=l(Math.ceil(Math.round((i.valid[1]-i.valid[0])/r.resolution)/t.size[0]),f[1]),p=l(Math.floor((i.origin[0]-s[0])/a[0]),c[1]),y=l(v[0]+p[0]-1,d[1]),g=!0):(p=c,y=d,v=f,g=!1),new e(r.level,r.resolution,r.scale,s,c,d,f,a,p,y,v,g)}}]),e}(),p=r(48790),y=(0,a.Z)((function e(t,r,n){(0,s.Z)(this,e),this.row=t,this.colFrom=r,this.colTo=n})),g=new c.Z("0/0/0/0"),_=function(){function e(t,r,n,i,a,o,u,c){(0,s.Z)(this,e),this.x=t,this.ymin=r,this.ymax=n,this.invM=i,this.leftAdjust=a,this.rightAdjust=o,this.leftBound=u,this.rightBound=c}return(0,a.Z)(e,[{key:"incrRow",value:function(){this.x+=this.invM}},{key:"getLeftCol",value:function(){return Math.max(this.x+this.leftAdjust,this.leftBound)}},{key:"getRightCol",value:function(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}],[{key:"create",value:function(t,r){var n;t[1]>r[1]&&(t=(n=[r,t])[0],r=n[1]);var s=t,a=(0,i.Z)(s,2),o=a[0],u=a[1],c=r,l=(0,i.Z)(c,2),h=l[0],d=l[1],f=h-o,v=d-u,p=0!==v?f/v:0,y=(Math.ceil(u)-u)*p,g=(Math.floor(u)-u)*p;return new e(o,Math.floor(u),Math.ceil(d),p,f<0?y:g,f<0?g:y,f<0?h:o,f<0?o:h)}}]),e}(),m=[[0,0],[0,0],[0,0],[0,0]],k=function(){function e(t){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;(0,s.Z)(this,e),this.tileInfo=t,this.fullExtent=n,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var i=t.lods.slice();i.sort((function(e,t){return t.scale-e.scale}));var a=this._lodInfos=i.map((function(e){return v.create(t,e,n)}));i.forEach((function(e,t){r._infoByLevel[e.level]=a[t],r._infoByScale[e.scale]=a[t],r.scales[t]=e.scale}),this),this._wrap=t.isWrappable}return(0,a.Z)(e,[{key:"spatialReference",get:function(){return this.tileInfo.spatialReference}},{key:"getLODInfoAt",value:function(e){return this._infoByLevel["number"==typeof e?e:e.level]}},{key:"getTileBounds",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];g.set(t);var n=this._infoByLevel[g.level];return n?n.getTileBounds(e,g,r):e}},{key:"getTileCoords",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];g.set(t);var n=this._infoByLevel[g.level];return n?n.getTileCoords(e,g,r):e}},{key:"getTileCoverage",value:function(e){var t,r,i,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:192,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"closest",o="closest"===a?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),u=p.Z.pool.acquire(o),c=this._wrap,l=1/0,h=-1/0,d=u.spans;m[0][0]=m[0][1]=m[1][1]=m[3][0]=-s,m[1][0]=m[2][0]=e.size[0]+s,m[2][1]=m[3][1]=e.size[1]+s;var f,v=(0,n.Z)(m);try{for(v.s();!(f=v.n()).done;){var g=f.value;e.toMap(g,g),g[0]=o.getColumnForX(g[0]),g[1]=o.getRowForY(g[1])}}catch(E){v.e(E)}finally{v.f()}for(var k=[],x=3,b=0;b<4;b++)if(m[b][1]!==m[x][1]){var I=_.create(m[b],m[x]);l=Math.min(I.ymin,l),h=Math.max(I.ymax,h),void 0===k[I.ymin]&&(k[I.ymin]=[]),k[I.ymin].push(I),x=b}else x=b;if(null==l||null==h||h-l>100)return null;var w=[];for(t=l;t<h;){null!=k[t]&&(w=w.concat(k[t])),r=1/0,i=-1/0;for(var S=w.length-1;S>=0;S--){var Z=w[S];r=Math.min(r,Z.getLeftCol()),i=Math.max(i,Z.getRightCol())}if(r=Math.floor(r),i=Math.floor(i),t>=o.first[1]&&t<=o.last[1])if(c)if(o.size[0]<o.worldSize[0])for(var C=Math.floor(i/o.worldSize[0]),F=Math.floor(r/o.worldSize[0]);F<=C;F++)d.push(new y(t,Math.max(o.getFirstColumnForWorld(F),r),Math.min(o.getLastColumnForWorld(F),i)));else d.push(new y(t,r,i));else r>o.last[0]||i<o.first[0]||(r=Math.max(r,o.first[0]),i=Math.min(i,o.last[0]),d.push(new y(t,r,i)));t+=1;for(var T=w.length-1;T>=0;T--){var A=w[T];A.ymax>=t?A.incrRow():w.splice(T,1)}}return u}},{key:"getTileParentId",value:function(e){g.set(e);var t=this._infoByLevel[g.level],r=this._lodInfos.indexOf(t)-1;return r<0?null:(this._getTileIdAtLOD(g,this._lodInfos[r],g),g.id)}},{key:"getTileResolution",value:function(e){var t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}},{key:"getTileScale",value:function(e){var t=this._infoByLevel[e.level];return t?t.scale:-1}},{key:"intersects",value:function(e,t){g.set(t);var r=this._infoByLevel[g.level],s=e.lodInfo;if(s.resolution>r.resolution){this._getTileIdAtLOD(g,s,g);var a,o=s.denormalizeCol(g.col,g.world),u=(0,n.Z)(e.spans);try{for(u.s();!(a=u.n()).done;){var c=a.value;if(c.row===g.row&&c.colFrom<=o&&c.colTo>=o)return!0}}catch(I){u.e(I)}finally{u.f()}}if(s.resolution<r.resolution){var l=e.spans.reduce((function(e,t){return e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e}),[1/0,-1/0,1/0,-1/0]),h=(0,i.Z)(l,4),d=h[0],f=h[1],v=h[2],p=h[3],y=r.denormalizeCol(g.col,g.world),_=s.getColumnForX(r.getXForColumn(y)),m=s.getRowForY(r.getYForRow(g.row)),k=s.getColumnForX(r.getXForColumn(y+1))-1,x=s.getRowForY(r.getYForRow(g.row+1))-1;return!(_>p||k<v||m>f||x<d)}var b=s.denormalizeCol(g.col,g.world);return e.spans.some((function(e){return e.row===g.row&&e.colFrom<=b&&e.colTo>=b}))}},{key:"normalizeBounds",value:function(e,t,r){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){var n=(0,o.C5)(this.tileInfo.spatialReference),i=-r*(n.valid[1]-n.valid[0]);e[0]+=i,e[2]+=i}return e}},{key:"getSmallestInfoForScale",value:function(e){var t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(var r=1;r<t.length-1;r++)if(e>t[r]+1e-6)return this._infoByScale[t[r-1]];return this._infoByScale[t[t.length-1]]}},{key:"getClosestInfoForScale",value:function(e){var t=this.scales;return this._infoByScale[e]||(e=t.reduce((function(t,r){return Math.abs(r-e)<Math.abs(t-e)?r:t}),t[0])),this._infoByScale[e]}},{key:"scaleToLevel",value:function(e){var t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(var r=t.length-1;r>=0;r--)if(e<t[r])return r===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[r]].level+(t[r]-e)/(t[r]-t[r+1]);return this._infoByScale[t[0]].level}},{key:"scaleToZoom",value:function(e){return this.tileInfo.scaleToZoom(e)}},{key:"_getTileIdAtLOD",value:function(e,t,r){var n=this._infoByLevel[r.level];return e.set(r),t.resolution<n.resolution?null:(t.resolution===n.resolution||(e.level=t.level,e.col=Math.floor(r.col*n.resolution/t.resolution+.01),e.row=Math.floor(r.row*n.resolution/t.resolution+.01)),e)}}]),e}()},73828:function(e,t,r){r.d(t,{Z:function(){return o}});var n=r(70885),i=r(15671),s=r(43144),a=r(13005),o=function(){function e(t,r,n,s){(0,i.Z)(this,e),this.set(t,r,n,s)}return(0,s.Z)(e,[{key:"key",get:function(){return this}},{key:"id",get:function(){return this.toString()},set:function(e){this.set(e)}},{key:"hash",get:function(){var e=4095&this.row,t=4095&this.col,r=63&this.level;return(3&this.world)<<30|t<<22|e<<8|r}},{key:"acquire",value:function(e,t,r,n){this.set(e,t,r,n)}},{key:"contains",value:function(e){var t=e.level-this.level;return this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}},{key:"equals",value:function(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}},{key:"clone",value:function(){return new e(this)}},{key:"release",value:function(){this.level=0,this.row=0,this.col=0,this.world=0}},{key:"set",value:function(e,t,r,i){if(null==e)this.level=0,this.row=0,this.col=0,this.world=0;else if("object"==typeof e)this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if("string"==typeof e){var s=e.split("/"),a=(0,n.Z)(s,4),o=a[0],u=a[1],c=a[2],l=a[3];this.level=parseFloat(o),this.row=parseFloat(u),this.col=parseFloat(c),this.world=parseFloat(l)}else this.level=+e,this.row=+t,this.col=+r,this.world=+i||0;return this}},{key:"toString",value:function(){return"".concat(this.level,"/").concat(this.row,"/").concat(this.col,"/").concat(this.world)}},{key:"getParentKey",value:function(){return this.level<=0?null:new e(this.level-1,this.row>>1,this.col>>1,this.world)}},{key:"getChildKeys",value:function(){var t=this.level+1,r=this.row<<1,n=this.col<<1,i=this.world;return[new e(t,r,n,i),new e(t,r,n+1,i),new e(t,r+1,n,i),new e(t,r+1,n+1,i)]}},{key:"compareRowMajor",value:function(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}],[{key:"getId",value:function(e,t,r,n){return"object"==typeof e?"".concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.world):"".concat(e,"/").concat(t,"/").concat(r,"/").concat(n)}}]),e}();o.pool=new a.Z(o,null,null,25,50)},12502:function(e,t,r){r.d(t,{e:function(){return h}});var n=r(43144),i=r(15671),s=r(92026),a=r(75298),o=r(37762),u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){return e.values().next().value};(0,i.Z)(this,e),this._peeker=t,this._items=new Set}return(0,n.Z)(e,[{key:"length",get:function(){return this._items.size}},{key:"clear",value:function(){this._items.clear()}},{key:"last",value:function(){if(0!==this._items.size){var e,t,r=(0,o.Z)(this._items);try{for(r.s();!(t=r.n()).done;)e=t.value}catch(n){r.e(n)}finally{r.f()}return e}}},{key:"peek",value:function(){if(0!==this._items.size)return this._peeker(this._items)}},{key:"push",value:function(e){this.contains(e)||this._items.add(e)}},{key:"contains",value:function(e){return this._items.has(e)}},{key:"pop",value:function(){if(0!==this.length){var e=this.peek();return this._items.delete((0,s.j0)(e)),e}}},{key:"popLast",value:function(){if(0!==this.length){var e=this.last();return this._items.delete((0,s.j0)(e)),e}}},{key:"remove",value:function(e){this._items.delete(e)}},{key:"filter",value:function(e){var t=this;return this._items.forEach((function(r){e(r)||t._items.delete(r)})),this}}]),e}(),c=r(99346),l=(0,n.Z)((function e(t,r){(0,i.Z)(this,e),this.item=t,this.controller=r,this.promise=null})),h=function(){function e(t){(0,i.Z)(this,e),this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,t.concurrency&&(this.concurrency=t.concurrency),this._queue=new u(t.peeker),this.process=t.process;var r=t.scheduler;t.priority&&(0,s.pC)(r)&&(this._task=r.registerTask(t.priority,this))}return(0,n.Z)(e,[{key:"destroy",value:function(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}},{key:"length",get:function(){return this._processingItems.size+this._queue.length}},{key:"abort",value:function(e){var t=this._controllers.get(e);t&&t.abort()}},{key:"clear",value:function(){this._queue.clear();var e=[];this._controllers.forEach((function(t){return e.push(t)})),this._controllers.clear(),e.forEach((function(e){return e.abort()})),this._processingItems.clear(),this._cancelNext()}},{key:"forEach",value:function(e){this._deferreds.forEach((function(t,r){return e(r)}))}},{key:"get",value:function(e){var t=this._deferreds.get(e);return t?t.promise:void 0}},{key:"isOngoing",value:function(e){return this._processingItems.has(e)}},{key:"has",value:function(e){return this._deferreds.has(e)}},{key:"pause",value:function(){this._isPaused||(this._isPaused=!0,this._cancelNext())}},{key:"push",value:function(e,t){var r=this,n=this.get(e);if(n)return n;var i=new AbortController,o=null;t&&(o=(0,a.fu)(t,(function(){return i.abort()})));var u=function(){c.remove(),(0,s.pC)(o)&&o.remove(),r._deferreds.delete(e),r._controllers.delete(e),r._queue.remove(e),r._processingItems.delete(e),r._scheduleNext()},c=(0,a.$F)(i.signal,(function(){var t=r._processingItems.get(e);t&&t.controller.abort(),u(),l.reject((0,a.zE)())})),l=(0,a.dD)();return this._deferreds.set(e,l),this._controllers.set(e,i),l.promise.then(u,u),this._queue.push(e),this._scheduleNext(),l.promise}},{key:"last",value:function(){return this._queue.last()}},{key:"peek",value:function(){return this._queue.peek()}},{key:"popLast",value:function(){return this._queue.popLast()}},{key:"reset",value:function(){var e=[];this._processingItems.forEach((function(t){return e.push(t)})),this._processingItems.clear();for(var t=0,r=e;t<r.length;t++){var n=r[t];this._queue.push(n.item),n.controller.abort()}this._scheduleNext()}},{key:"resume",value:function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}},{key:"takeAll",value:function(){for(var e=[];this._queue.length;)e.push(this._queue.pop());return this.clear(),e}},{key:"running",get:function(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}},{key:"runTask",value:function(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}},{key:"_scheduleNext",value:function(){var e=this;this._task||this._isPaused||this._schedule||(this._schedule=(0,c.Os)((function(){e._schedule=null,e._next()})))}},{key:"_next",value:function(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}},{key:"_cancelNext",value:function(){this._schedule&&(this._schedule.remove(),this._schedule=null)}},{key:"_processResult",value:function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}},{key:"_processError",value:function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}},{key:"_canProcessFulfillment",value:function(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}},{key:"_process",value:function(e){var t=this;if(!(0,s.Wi)(e)){var r,n=new AbortController,i=new l(e,n);this._processingItems.set(e,i);try{r=this.process(e,n.signal)}catch(o){this._processError(i,o)}(0,a.y8)(r)?(i.promise=r,r.then((function(e){return t._processResult(i,e)}),(function(e){return t._processError(i,e)}))):this._processResult(i,r)}}},{key:"test",get:function(){var e=this;return{update:function(t){return e.runTask(t)}}}}]),e}()}}]);
//# sourceMappingURL=8760.e732b59e.chunk.js.map